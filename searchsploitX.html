<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SearchSploit X: Multi-Engine Recon Toolkit</title>
    <meta name="description" content="SearchSploit X: Multi-Engine Recon Toolkit - Advanced search queries for security researchers.">
    <meta name="theme-color" content="#4a7dff">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%234a7dff' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15H9v-2h2v2zm0-4H9V7h2v6zm4 0h-2V7h2v6z'/%3E%3C/svg%3E">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- CSS Variables for Theming --- */
        :root {
            /* Light Mode Defaults */
            --bg-primary: #f2f5f9; /* App background - slightly off-white */
            --bg-secondary: #ffffff; /* Card/Sidebar background */
            --bg-card: #ffffff; /* Explicit card background */
            --text-primary: #343a40; /* Main text color - dark grey */
            --text-secondary: #6c757d; /* Secondary text, placeholders - medium grey */
            --border-color: #e0e6ed; /* Borders, separators - light grey */
            --accent-color: #4a7dff; /* Primary interactive color - vibrant blue */
            --accent-hover: #3a68e8; /* Hover state for accent */
            --nav-bg: #e6eaf0; /* Navigation item background - very light grey-blue */
            --nav-item-hover: #d0d6df; /* Nav item hover state */
            --nav-item-active: #c2cbd2; /* Nav item active state */
            --shadow-light: rgba(0, 0, 0, 0.08); /* Subtle shadow */
            --shadow-medium: rgba(0, 0, 0, 0.2); /* Stronger shadow */
            --toast-bg-success: #d4edda;
            --toast-text-success: #155724;
            --toast-bg-error: #f8d7da;
            --toast-text-error: #721c24;
            --toast-bg-info: #d1ecf1; /* New: info toast */
            --toast-text-info: #0c5460; /* New: info toast */
            --code-bg: #eaf1f7; /* Light code background */
            --code-text: #343a40;
            --button-secondary-bg: #e0e6ed;
            --button-secondary-hover: #d0d6df;
            --modal-overlay-bg: rgba(0, 0, 0, 0.5); /* Modal overlay */
            --modal-bg: var(--bg-card);
            --modal-border: var(--border-color);
        }

        /* OSINT/Investigation Style Dark Mode Overrides */
        body.dark-mode {
            --bg-primary: #1A1A2E; /* Deep space blue/purple */
            --bg-secondary: #24243D; /* Slightly lighter dark blue */
            --bg-card: #2F304B; /* Darker slate for cards, distinct from background */
            --text-primary: #E0E0FF; /* Soft white/lavender for readability */
            --text-secondary: #A0A0C0; /* Muted blue-grey */
            --border-color: #3B3B5E; /* Subtle purple-blue border */
            --accent-color: #00F0FF; /* Cyan/electric blue for main interactions, "radiant" feel */
            --accent-hover: #00D0E0; /* Slightly darker cyan */
            --nav-bg: #282845; /* Even darker nav background */
            --nav-item-hover: #38385A; /* Darker nav item hover */
            --nav-item-active: #48486F; /* Active nav item, more prominent */
            --shadow-light: rgba(0, 0, 0, 0.4);
            --shadow-medium: rgba(0, 0, 0, 0.7);
            --toast-bg-success: #2E5C32; /* Darker green for success */
            --toast-text-success: #97D09B;
            --toast-bg-error: #5A2C2E; /* Darker red for error */
            --toast-text-error: #E08F90;
            --toast-bg-info: #234C52; /* Darker teal for info */
            --toast-text-info: #A0D8ED;
            --code-bg: #1F1F35; /* Very dark, almost black for code blocks */
            --code-text: #00F0FF; /* Cyan for code for high contrast */
            --button-secondary-bg: #3B3B5E;
            --button-secondary-hover: #4B4B7F;
            --modal-overlay-bg: rgba(0, 0, 0, 0.8);
            --modal-bg: #24243D;
            --modal-border: #4B4B7F;
        }

        /* --- Global Reset & Base Styles --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scroll from layout shifts */
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: 16px;
            line-height: 1.6;
        }

        /* --- Global Top Navigation Bar --- */
        #top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 25px; /* Increased padding */
            box-shadow: 0 2px 8px var(--shadow-light); /* Softer, broader shadow */
            z-index: 1000;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .app-logo-title {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 5px 0; /* Add a bit of hit area */
        }

        .app-logo {
            height: 32px; /* Slightly larger logo */
            margin-right: 12px;
            pointer-events: none;
            color: var(--accent-color); /* Ensure SVG inherits color */
        }

        .app-title {
            font-size: 1.6em; /* Slightly larger title */
            font-weight: 700; /* Bolder */
            color: var(--accent-color);
        }

        .global-search-container {
            display: flex;
            align-items: center;
            background-color: var(--nav-bg);
            border-radius: 25px; /* Pill-shaped search bar */
            padding: 8px 15px; /* More padding */
            width: 450px; /* Wider search bar */
            max-width: 100%;
            border: 1px solid var(--border-color); /* Subtle border */
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.2s ease;
        }
        .global-search-container:focus-within {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(74, 125, 255, 0.2); /* Accent color glow */
            body.dark-mode & {
                box-shadow: 0 0 0 2px var(--accent-color); /* Dark mode glow */
            }
        }

        #global-search-input {
            border: none;
            background: transparent;
            width: 100%;
            padding: 0; /* Remove default input padding */
            font-size: 1em;
            color: var(--text-primary);
            outline: none;
        }
        #global-search-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.8;
        }

        #global-search-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0 5px; /* Adjusted padding */
            font-size: 1.25em; /* Larger icon */
            transition: color 0.2s ease;
        }
        #global-search-button:hover {
            color: var(--accent-color);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 20px; /* More space between icons */
        }

        /* Theme Toggle Button */
        .icon-theme-toggle {
            background: none;
            border: none;
            font-size: 1.5em; /* Larger icon */
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s ease;
            position: relative;
            width: 28px; /* Fixed width/height for smooth transition */
            height: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            padding: 0;
            border-radius: 50%;
        }
        .icon-theme-toggle span {
            position: absolute;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out; /* Smoother animation */
        }
        .icon-sun { transform: translateY(0); opacity: 1; }
        .dark-mode .icon-sun { transform: translateY(-30px); opacity: 0; } /* Larger translation */
        .icon-moon { transform: translateY(30px); opacity: 0; }
        .dark-mode .icon-moon { transform: translateY(0); opacity: 1; }
        .icon-theme-toggle:hover { color: var(--accent-color); background-color: var(--nav-bg); }

        /* Dropdowns (Notifications, User Profile) */
        .notification-dropdown,
        .user-profile-dropdown {
            position: relative;
        }
        .notification-dropdown button,
        .user-profile-dropdown button {
            background: none;
            border: none;
            font-size: 1.5em; /* Larger icons */
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0; /* Remove default button padding */
            position: relative;
            transition: color 0.2s ease;
            width: 32px; /* Ensure sufficient clickable area */
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .notification-dropdown button:hover,
        .user-profile-dropdown button:hover {
            color: var(--accent-color);
            background-color: var(--nav-bg);
        }

        .notification-badge {
            position: absolute;
            top: -2px; /* Adjusted position */
            right: -2px; /* Adjusted position */
            background-color: #e74c3c; /* Red for notifications */
            color: white;
            border-radius: 50%;
            padding: 3px 7px; /* Larger padding */
            font-size: 0.75em; /* Slightly larger font */
            line-height: 1;
            min-width: 22px; /* Ensure good circle */
            text-align: center;
            border: 1px solid var(--bg-secondary); /* Border to stand out */
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            z-index: 1; /* Above dropdown button */
        }

        .user-avatar img {
            width: 34px; /* Slightly larger avatar */
            height: 34px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .user-profile-dropdown button:hover .user-avatar img {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px var(--accent-color); /* Dark mode glow */
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--bg-card);
            min-width: 180px;
            box-shadow: 0px 10px 20px var(--shadow-medium); /* Deeper shadow */
            z-index: 1;
            border-radius: 8px;
            padding: 10px 0;
            right: 0;
            top: 48px; /* Position below button with more clearance */
            opacity: 0;
            transform: translateY(-15px); /* More pronounced slide-up */
            transition: opacity 0.25s ease-out, transform 0.25s ease-out, visibility 0.25s ease-out;
            visibility: hidden;
            border: 1px solid var(--border-color);
        }
        .dropdown-content.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }
        .dropdown-content a {
            color: var(--text-primary);
            padding: 12px 20px; /* More padding */
            text-decoration: none;
            display: block;
            white-space: nowrap;
            font-size: 0.95em; /* Slightly smaller for menu items */
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .dropdown-content a:hover {
            background-color: var(--nav-item-hover);
            color: var(--accent-color);
        }

        /* --- Persistent Left Sidebar Navigation --- */
        #left-sidebar {
            position: fixed;
            top: 60px; /* Below top nav */
            left: 0;
            bottom: 0;
            width: 250px; /* Wider sidebar */
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding-top: 30px; /* More top padding */
            box-shadow: 3px 0 8px var(--shadow-light); /* More pronounced shadow */
            z-index: 900;
            overflow-y: auto;
            transition: width 0.3s ease, background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #left-sidebar::-webkit-scrollbar { width: 8px; }
        #left-sidebar::-webkit-scrollbar-track { background: var(--bg-secondary); }
        #left-sidebar::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        body.dark-mode #left-sidebar::-webkit-scrollbar-track { background: var(--bg-secondary); }
        body.dark-mode #left-sidebar::-webkit-scrollbar-thumb { background: #555; }


        #left-sidebar ul {
            list-style: none;
            padding-right: 20px; /* Padding for the pill effect */
        }

        #left-sidebar .nav-item {
            margin-bottom: 8px; /* More space between items */
        }

        #left-sidebar .nav-item a {
            display: flex;
            align-items: center;
            padding: 14px 20px; /* More padding */
            color: var(--text-primary);
            text-decoration: none;
            font-size: 1em; /* Standard font size */
            font-weight: 500; /* Medium weight */
            border-radius: 0 30px 30px 0; /* More rounded pill shape */
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease;
        }

        #left-sidebar .nav-item a .icon {
            font-size: 1.3em; /* Larger icons */
            margin-right: 15px; /* More space */
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }
        #left-sidebar .nav-item a:hover {
            background-color: var(--nav-item-hover);
            color: var(--accent-color);
            transform: translateX(5px); /* Slight slide on hover */
        }
        #left-sidebar .nav-item.active a {
            background-color: var(--nav-item-active);
            color: var(--accent-color);
            font-weight: 600;
            box-shadow: inset 5px 0 0 var(--accent-color); /* Left border highlight */
        }
        #left-sidebar .nav-item.active a .icon {
            color: var(--accent-color);
        }

        /* --- Main Content Area --- */
        #app-content {
            margin-left: 250px; /* Offset for wider sidebar */
            padding: 90px 30px 30px 30px; /* More padding, adjusted top for nav */
            flex-grow: 1;
            transition: margin-left 0.3s ease;
        }

        .module-content {
            display: none;
            padding: 30px; /* Increased padding */
            background-color: var(--bg-card);
            border-radius: 12px; /* More rounded corners */
            box-shadow: 0 5px 20px var(--shadow-light); /* Softer, broader shadow */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .module-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out; /* Simple fade-in for module switch */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .module-content h1 {
            color: var(--text-primary); /* Darker primary for headings */
            margin-bottom: 25px;
            font-size: 2.2em; /* Larger headings */
            font-weight: 700;
            border-bottom: 2px solid var(--border-color); /* Thicker border */
            padding-bottom: 18px; /* More padding */
            transition: border-color 0.3s ease, color 0.3s ease;
        }

        .module-content h2 {
            color: var(--text-primary);
            margin-top: 35px; /* More top margin */
            margin-bottom: 20px; /* More bottom margin */
            font-size: 1.8em;
            font-weight: 600;
        }

        /* --- Common Styles for Forms/Buttons/Inputs --- */
        .action-button, button:not(.icon-theme-toggle):not(.user-avatar):not(.icon-notifications) {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 25px; /* Larger buttons */
            border-radius: 8px; /* More rounded */
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Subtle button shadow */
        }

        .action-button:hover, button:not(.icon-theme-toggle):not(.user-avatar):not(.icon-notifications):hover {
            background-color: var(--accent-hover);
            transform: translateY(-2px); /* More pronounced lift */
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); /* Deeper shadow on hover */
        }

        .action-button:active, button:not(.icon-theme-toggle):not(.user-avatar):not(.icon-notifications):active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .action-button.secondary {
            background-color: var(--button-secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            box-shadow: none; /* No initial shadow for secondary */
        }
        .action-button.secondary:hover {
            background-color: var(--button-secondary-hover);
            border-color: var(--accent-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Subtle shadow on hover */
        }

        select, input[type="text"], input[type="password"], textarea {
            padding: 12px 15px; /* More padding */
            border: 1px solid var(--border-color);
            border-radius: 8px; /* More rounded */
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1em;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease;
        }

        select:focus, input[type="text"]:focus, input[type="password"]:focus, textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--accent-color); /* More prominent glow, uses accent color */
        }

        textarea {
            min-height: 150px; /* Taller text area */
            font-family: 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
            background-color: var(--code-bg);
            color: var(--code-text);
            padding: 20px; /* More padding */
            line-height: 1.6;
            tab-size: 4; /* Standard tab size */
        }

        /* --- Dashboard Styles --- */
        .summary-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Slightly larger min-width */
            gap: 25px; /* More gap */
            margin-bottom: 35px;
        }

        .summary-card {
            background-color: var(--bg-secondary);
            padding: 25px; /* More padding */
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-light); /* More prominent shadow */
            text-align: center;
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
        }
        .summary-card:hover {
            transform: translateY(-5px); /* Lift on hover */
            box-shadow: 0 8px 20px var(--shadow-medium);
        }
        .summary-card h3 {
            color: var(--text-secondary);
            font-size: 1.1em; /* Slightly larger */
            margin-bottom: 12px;
        }
        .summary-card p {
            font-size: 2.8em; /* Larger numbers */
            font-weight: 700;
            color: var(--accent-color);
            line-height: 1; /* Tightly packed number */
        }
        .summary-card p.small-text { /* For time or date fields */
            font-size: 1em;
            font-weight: 500;
            color: var(--text-primary);
        }


        .dashboard-section {
            margin-bottom: 40px; /* More vertical spacing */
        }
        .chart-container {
            height: 350px; /* Taller charts */
            background-color: var(--bg-secondary);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-light);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .quick-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* --- Query Builder --- */
        .query-builder-controls {
            display: flex;
            align-items: center;
            gap: 20px; /* More space */
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .query-builder-controls label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.05em;
        }
        #engine-selector {
            min-width: 180px; /* Wider select */
        }

        /* Query Builder Mode Toggle */
        .query-builder-mode-toggle {
            display: flex;
            gap: 10px;
            margin-left: auto; /* Push to right */
            flex-shrink: 0;
        }
        .query-builder-mode-toggle button {
            padding: 8px 15px;
            border-radius: 6px;
            background-color: var(--button-secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            font-weight: 500;
        }
        .query-builder-mode-toggle button.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        /* New: Advanced Query Builder fields */
        #structured-query-fields {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        .query-field-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .query-field-row select,
        .query-field-row input[type="text"] {
            flex: 1;
            min-width: 150px;
        }
        .query-field-row .remove-field-button {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2em;
            transition: background-color 0.2s ease;
        }
        .query-field-row .remove-field-button:hover {
            background-color: #c0392b;
        }

        .add-operator-button {
            margin-top: 10px;
            width: fit-content;
        }

        #manual-query-input {
            width: 100%;
            min-height: 200px;
            margin-bottom: 20px;
        }

        .linter-feedback {
            font-size: 0.95em;
            line-height: 1.5;
            padding: 12px 18px; /* More padding */
            border-radius: 8px;
            margin-top: 15px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); /* Inner shadow */
            display: none; /* Hidden by default */
        }
        .linter-feedback.error {
            background-color: var(--toast-bg-error);
            color: var(--toast-text-error);
            border-color: var(--toast-text-error);
        }
        .linter-feedback.warning {
            background-color: var(--toast-bg-info); /* Use info style for warnings */
            color: var(--toast-text-info);
            border-color: var(--toast-text-info);
        }


        .query-preview-container {
            margin-top: 25px; /* Added spacing */
            margin-bottom: 35px;
            background-color: var(--code-bg);
            padding: 20px;
            border-radius: 10px;
            border: 1px dashed var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
            position: relative; /* For copy button positioning */
        }
        .query-preview-container h2 {
            font-size: 1.3em;
            margin-bottom: 12px;
            color: var(--text-secondary);
        }
        #live-query-preview {
            font-size: 0.95em;
            color: var(--code-text);
            word-break: break-all;
            white-space: pre-wrap;
            user-select: all; /* Allow easy selection */
        }
        .query-preview-container .copy-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: var(--button-secondary-bg);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            opacity: 0.7;
            transition: opacity 0.2s ease, background-color 0.2s ease, color 0.2s ease;
        }
        .query-preview-container .copy-button:hover {
            opacity: 1;
            background-color: var(--button-secondary-hover);
            color: var(--text-primary);
        }


        .query-actions {
            display: flex;
            gap: 12px; /* More space */
            flex-wrap: wrap;
        }

        /* --- Template Library --- */
        .filter-search-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 20px; /* More space */
            margin-bottom: 30px;
            align-items: center;
        }
        #template-search {
            flex-grow: 1;
            min-width: 250px; /* Wider search input */
        }
        .filter-panel {
            display: flex;
            gap: 15px; /* More space */
            flex-wrap: wrap;
        }
        .template-view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .template-view-toggle button {
            padding: 8px 15px;
            border-radius: 6px;
            background-color: var(--button-secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .template-view-toggle button.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }


        /* Card View */
        .template-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); /* Larger cards */
            gap: 30px; /* More gap */
        }

        .template-card {
            background-color: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-light);
            padding: 25px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
            cursor: pointer; /* Indicate clickable */
        }
        .template-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px var(--shadow-medium);
        }
        .template-card h3 {
            color: var(--accent-color);
            font-size: 1.4em; /* Larger title */
            margin-bottom: 12px;
            font-weight: 600;
        }
        .template-description {
            font-size: 0.95em;
            color: var(--text-secondary);
            margin-bottom: 10px; /* Less margin before query preview */
            flex-grow: 1; /* Allows description to take available space */
        }
        /* New: Template card query preview */
        .template-code-preview {
            background-color: var(--code-bg);
            color: var(--code-text);
            font-family: 'Fira Code', monospace;
            font-size: 0.8em; /* Smaller font for snippet */
            padding: 8px 10px;
            border-radius: 4px;
            margin-bottom: 15px; /* Spacing below code preview */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap; /* Keep on single line */
            border: 1px solid var(--border-color);
        }

        .template-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 15px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        .compatibility-icons img {
            height: 22px; /* Slightly larger icons */
            margin-right: 6px;
        }

        .risk-level {
            padding: 6px 12px; /* Larger padding */
            border-radius: 6px;
            font-size: 0.85em; /* Slightly larger font */
            font-weight: 700;
        }
        .risk-high { background-color: #f8d7da; color: #721c24; }
        .risk-medium { background-color: #fff3cd; color: #856404; }
        .risk-low { background-color: #d4edda; color: #155724; }
        /* Dark mode risk colors */
        .dark-mode .risk-high { background-color: #5A2C2E; color: #E08F90; }
        .dark-mode .risk-medium { background-color: #5C5220; color: #FFD76D; }
        .dark-mode .risk-low { background-color: #2E5C32; color: #97D09B; }

        .template-actions {
            display: flex;
            gap: 10px;
            margin-top: auto;
            flex-wrap: wrap; /* Ensure buttons wrap */
            padding-top: 15px; /* Separate from description */
            border-top: 1px solid var(--border-color); /* Subtle separator */
        }
        .template-actions .action-button {
            padding: 10px 18px; /* Adjusted padding */
            font-size: 0.9em;
        }
        .favorite-button {
            background: none; /* No background */
            border: none;
            padding: 0;
            width: 32px; /* Fixed size */
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            color: var(--text-secondary); /* Default color for outline star */
        }
        .favorite-button:hover {
            background-color: var(--nav-item-hover);
        }
        /* Favorite Icon Styling */
        .icon-favorite::before {
            content: "☆"; /* Hollow star for unfavorited */
            font-size: 1.3em;
        }
        .favorite-button .icon-favorite.active::before,
        .saved-query-item .favorite-toggle .icon-favorite.active::before {
            content: "★"; /* Solid star for favorited */
            color: gold; /* Filled star color */
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); /* Subtle glow */
        }


        /* List View */
        .template-list-container {
            display: none; /* Hidden by default */
            width: 100%;
        }
        .template-list-container table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden; /* For rounded corners */
            box-shadow: 0 4px 15px var(--shadow-light);
        }
        .template-list-container th,
        .template-list-container td {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
        }
        .template-list-container th {
            background-color: var(--nav-bg);
            font-weight: 600;
            color: var(--text-primary);
        }
        .template-list-container tbody tr:last-child td {
            border-bottom: none;
        }
        .template-list-container tbody tr:hover {
            background-color: var(--nav-item-hover);
            cursor: pointer;
        }
        .template-list-container .template-list-actions {
            display: flex;
            gap: 5px;
            white-space: nowrap;
        }
        .template-list-container .template-list-actions button {
            padding: 6px 10px;
            font-size: 0.8em;
        }
        .template-list-container .template-description-cell {
            max-width: 250px; /* Limit width */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        /* New: Template list query preview */
        .template-list-code-preview {
            background-color: var(--code-bg);
            color: var(--code-text);
            font-family: 'Fira Code', monospace;
            font-size: 0.75em; /* Even smaller for list table */
            padding: 5px 8px;
            border-radius: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap; /* Keep on single line */
            border: 1px solid var(--border-color);
            display: inline-block; /* To respect max-width */
            max-width: 200px; /* Limit width in table cell */
            vertical-align: middle;
        }


        /* --- Saved Queries Manager --- */
        .saved-queries-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .saved-queries-list {
            display: flex;
            flex-direction: column;
            gap: 20px; /* More space */
        }
        .saved-query-item {
            background-color: var(--bg-secondary);
            border-radius: 10px;
            box-shadow: 0 3px 10px var(--shadow-light);
            padding: 20px 25px; /* More padding */
            display: flex;
            align-items: center;
            gap: 20px; /* More space */
            flex-wrap: wrap;
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
        }
        .saved-query-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px var(--shadow-medium);
        }
        .saved-query-item .query-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1em;
            flex-basis: 220px;
            flex-grow: 1;
            min-width: 180px;
        }
        .saved-query-item .query-engine {
            font-size: 0.9em;
            color: var(--text-secondary);
            white-space: nowrap;
            background-color: var(--nav-bg);
            padding: 4px 10px;
            border-radius: 5px;
        }
        .saved-query-item .query-text {
            font-size: 0.9em;
            padding: 8px 12px;
            flex-grow: 2;
            min-width: 280px; /* Ensure it takes reasonable space */
            background-color: var(--code-bg);
            border-radius: 6px;
            border: 1px solid var(--border-color);
            color: var(--code-text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap; /* Keep it on one line in the list */
        }
        .saved-query-item .query-actions {
            display: flex;
            gap: 10px;
            margin-left: auto;
            flex-wrap: wrap;
        }
        .saved-query-item .query-actions button {
            padding: 8px 15px;
            font-size: 0.85em;
        }
        .saved-query-item .favorite-toggle {
            background: none; /* No background */
            border: none;
            padding: 0;
            width: 30px; height: 30px; font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s ease;
            color: var(--text-secondary); /* Default color for outline star */
        }
        .saved-query-item .favorite-toggle:hover {
            background-color: var(--nav-item-hover);
        }

        /* --- Query Converter Engine --- */
        .converter-selectors {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .converter-selectors label { font-weight: 600; color: var(--text-primary); }
        .converter-selectors select {
            width: 170px;
            padding: 10px;
        }

        .query-diff-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 25px; /* More gap */
            margin-bottom: 30px;
            align-items: center;
            min-height: 250px; /* Taller container */
        }
        .source-query-input, .target-query-output {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .source-query-input textarea, .target-query-output textarea {
            flex-grow: 1;
            min-height: 180px; /* Ensure sufficient height */
        }
        .conversion-actions {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .conversion-actions button {
            padding: 18px 30px; /* Larger button */
            font-size: 1.2em;
            border-radius: 50%; /* Circular button */
            min-width: 60px; /* Ensure circular */
            min-height: 60px;
        }
        .conversion-actions .icon-arrow-right::before { content: "→"; margin-right: 0 !important; font-size: 1.6em;} /* Larger arrow */


        .conversion-feedback {
            font-size: 0.95em;
            line-height: 1.5;
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 25px;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.1);
            display: none;
        }
        .conversion-feedback.active {
            display: block;
            background-color: var(--toast-bg-info); /* Use info style for warnings */
            color: var(--toast-text-info);
            border-color: var(--toast-text-info);
        }
        .conversion-feedback.error { /* Add error styling for conversion feedback */
            background-color: var(--toast-bg-error);
            color: var(--toast-text-error);
            border-color: var(--toast-text-error);
        }


        /* --- Random Dork Generator --- */
        .generator-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 35px;
            flex-wrap: wrap;
            align-items: center;
        }
        .generator-controls label { font-weight: 600; color: var(--text-primary); }
        .generator-controls select {
            width: 200px;
            padding: 10px;
        }

        .generated-dork-output {
            background-color: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-light);
            padding: 30px; /* More padding */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        #generated-dork-title {
            color: var(--accent-color);
            margin-bottom: 15px;
            font-size: 1.8em; /* Larger title */
            font-weight: 600;
        }
        #generated-dork-description {
            color: var(--text-secondary);
            font-size: 1em;
            margin-bottom: 25px;
        }
        #generated-dork-query {
            min-height: 100px; /* Ensure visible */
            font-size: 0.95em;
            padding: 18px;
            margin-bottom: 25px;
            background-color: var(--code-bg);
            color: var(--code-text);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
            user-select: all;
        }
        .generated-dork-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* --- Engine Compatibility Matrix --- */
        .compatibility-table-container {
            overflow-x: auto;
            margin-bottom: 35px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            transition: border-color 0.3s ease;
            background-color: var(--bg-secondary); /* Ensure table background matches card */
            box-shadow: 0 2px 10px var(--shadow-light);
        }
        #compatibility-table {
            width: 100%;
            border-collapse: separate; /* For rounded corners on cells */
            border-spacing: 0;
            font-size: 0.95em;
            min-width: 700px; /* Ensure horizontal scroll on smaller screens */
        }
        #compatibility-table th, #compatibility-table td {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            text-align: left;
            white-space: nowrap;
        }
        #compatibility-table th {
            background-color: var(--nav-bg);
            font-weight: 700;
            color: var(--text-primary);
            position: sticky; /* Keep header visible on scroll */
            top: 0;
            z-index: 1;
        }
        #compatibility-table th:last-child,
        #compatibility-table td:last-child {
            border-right: none; /* No right border on last column */
        }
        #compatibility-table tbody tr:last-child td {
            border-bottom: none;
        }
        #compatibility-table tbody tr:nth-child(even) {
            background-color: var(--bg-primary);
        }
        #compatibility-table tbody tr:hover {
            background-color: var(--nav-item-hover);
        }

        .support-icon {
            font-weight: 800; /* Bolder */
            font-size: 1.2em; /* Larger icon */
        }
        .support-yes { color: #28a745; }
        .support-no { color: #dc3545; }
        .support-partial { color: #ffc107; }

        .engine-docs-links ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 20px; /* More space */
        }
        .engine-docs-links a {
            font-size: 1em;
            font-weight: 500;
        }

        /* --- Analytics & Usage History --- */
        .analytics-charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); /* Larger charts */
            gap: 30px;
            margin-bottom: 35px;
        }
        .chart-card {
            background-color: var(--bg-secondary);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-light);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .chart-card h2 {
            font-size: 1.4em;
            margin-bottom: 15px;
            color: var(--text-primary);
            text-align: center;
        }
        .analytics-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* --- Settings & Legal --- */
        .setting-group {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            transition: border-color 0.3s ease;
        }
        .setting-group:last-of-type {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }
        .setting-group h2 {
            font-size: 1.8em;
            margin-bottom: 15px;
            color: var(--text-primary);
            font-weight: 600;
        }
        .setting-group p {
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 0.95em;
        }
        .setting-group div {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px; /* Space between input rows */
            flex-wrap: wrap;
        }
        .setting-group label {
            font-weight: 500;
            color: var(--text-primary);
            flex-basis: 120px; /* Consistent label width */
            flex-shrink: 0;
            font-size: 1em;
        }
        .setting-group input[type="password"], .setting-group select {
            flex-grow: 1;
            max-width: 400px; /* Limit max width for readability */
        }
        .setting-group .action-button {
            padding: 10px 20px;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .legal-disclaimer {
            background-color: var(--toast-bg-error);
            color: var(--toast-text-error);
            border: 1px solid currentColor;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 35px;
            font-size: 0.95em;
            font-weight: 500;
            line-height: 1.6;
        }

        .help-content ul {
            list-style: disc;
            margin-left: 25px; /* More indentation */
        }
        .help-content li {
            margin-bottom: 10px;
            font-size: 0.95em;
        }
        .help-content a {
            font-weight: 500;
        }

        /* --- Global Toast Notifications --- */
        #toast-container {
            position: fixed;
            bottom: 25px; /* More offset */
            right: 25px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 12px; /* More space */
            pointer-events: none;
        }
        .toast {
            padding: 18px 25px; /* More padding */
            border-radius: 10px;
            box-shadow: 0 6px 18px var(--shadow-medium); /* Deeper shadow */
            min-width: 280px; /* Wider */
            max-width: 400px; /* Max width */
            border: 1px solid currentColor;
            font-size: 1em;
            font-weight: 500;
            line-height: 1.5;
            opacity: 0;
            transform: translateY(30px); /* Larger slide-up */
            transition: opacity 0.35s ease-out, transform 0.35s ease-out; /* Smoother animation */
            pointer-events: all;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast .toast-icon {
            font-size: 1.5em;
            line-height: 1;
        }
        .toast.success { background-color: var(--toast-bg-success); color: var(--toast-text-success); border-color: var(--toast-text-success); }
        .toast.error { background-color: var(--toast-bg-error); color: var(--toast-text-error); border-color: var(--toast-text-error); }
        .toast.info { background-color: var(--toast-bg-info); color: var(--toast-text-info); border-color: var(--toast-text-info); }


        /* --- Custom Modals --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--modal-bg);
            border-radius: 12px;
            box-shadow: 0 10px 30px var(--shadow-medium);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
            border: 1px solid var(--modal-border);
            position: relative;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        .modal-content h3 {
            font-size: 1.6em;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .modal-content p {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }
        .modal-content label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        .modal-content input[type="text"],
        .modal-content textarea.query-preview {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1em;
            resize: vertical;
            min-height: 80px;
            font-family: 'Fira Code', monospace;
            cursor: text;
        }
        .modal-content textarea.query-preview {
            background-color: var(--code-bg);
            color: var(--code-text);
            user-select: text;
            cursor: auto;
        }
        .modal-content .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap; /* Ensure buttons wrap gracefully */
        }
        .modal-content .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .modal-content .modal-close:hover {
            color: var(--accent-color);
        }


        /* --- Basic Icon Placeholders (using Unicode for simplicity) --- */
        .icon::before {
            display: inline-block;
            margin-right: 10px; /* More space for icons */
            vertical-align: middle; /* Align with text */
        }
        .icon-dashboard::before { content: "📊"; }
        .icon-builder::before { content: "🛠️"; }
        .icon-library::before { content: "📚"; }
        .icon-save::before { content: "💾"; }
        .icon-convert::before { content: "🔄"; }
        .icon-random::before { content: "🎲"; }
        .icon-matrix::before { content: "🚦"; }
        .icon-analytics::before { content: "📈"; }
        .icon-settings::before { content: "⚙️"; }
        .icon-help::before { content: "❓"; }
        .icon-wayback::before { content: "⏳"; } /* New icon for Wayback Machine */
        .icon-search::before { content: "🔍"; margin-right: 0 !important; font-size: 1.1em;} /* Override for search button */
        .icon-notifications::before { content: "🔔"; margin-right: 0 !important; }
        .icon-sun::before { content: "☀️"; margin-right: 0 !important; }
        .icon-moon::before { content: "🌙"; margin-right: 0 !important; }
        /* Favorite icon overridden by specific CSS for hollow/solid */
        .icon-delete::before { content: "🗑️"; margin-right: 0 !important; }
        .icon-copy::before { content: "📋"; margin-right: 5px; } /* New copy icon */
        .icon-card-view::before { content: "🎴"; margin-right: 5px; }
        .icon-list-view::before { content: "📜"; margin-right: 5px; }
        .toast-icon.success::before { content: "✅"; }
        .toast-icon.error::before { content: "❌"; }
        .toast-icon.info::before { content: "ℹ️"; }


        /* --- Responsive Adjustments (Mobile-First approach, then larger screens) --- */
        /* Extra small devices (phones, 480px and below) */
        @media (max-width: 480px) {
            body { font-size: 14px; }
            #top-nav { height: 55px; padding: 0 15px; }
            .app-logo { height: 28px; margin-right: 8px; }
            .app-title { display: none; }
            .global-search-container { width: 100%; margin: 0 8px; padding: 6px 12px; }
            #global-search-input { font-size: 0.9em; }
            .nav-right { gap: 12px; }
            .icon-theme-toggle, .notification-dropdown button, .user-profile-dropdown button { font-size: 1.3em; width: 28px; height: 28px; }
            .notification-badge { padding: 2px 6px; font-size: 0.65em; min-width: 18px; }
            .user-avatar img { width: 30px; height: 30px; }
            .dropdown-content { top: 40px; min-width: 150px; padding: 8px 0;}
            .dropdown-content a { padding: 10px 15px; font-size: 0.9em;}

            #left-sidebar {
                width: 0;
                padding-top: 0;
                border-right: none;
                box-shadow: none;
            }
            #app-content {
                margin-left: 0;
                padding: 75px 15px 20px 15px; /* Adjust padding for smaller top nav */
            }

            .module-content { padding: 20px; border-radius: 8px; }
            .module-content h1 { font-size: 1.8em; margin-bottom: 20px; padding-bottom: 12px; }
            .module-content h2 { font-size: 1.4em; margin-top: 25px; margin-bottom: 15px;}

            .summary-cards-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .summary-card { padding: 20px; }
            .summary-card p { font-size: 2.2em; }
            .summary-card p.small-text { font-size: 0.9em; }


            .action-button { padding: 10px 18px; font-size: 0.9em; border-radius: 6px; }
            select, input[type="text"], input[type="password"], textarea { padding: 10px 12px; font-size: 0.9em; border-radius: 6px; }

            .filter-search-bar { flex-direction: column; align-items: stretch; gap: 10px; }
            #template-search { min-width: unset; }
            .filter-panel { flex-direction: column; width: 100%; gap: 8px; }
            .filter-panel select { width: 100%; }

            .template-card { padding: 20px; border-radius: 8px; }
            .template-card h3 { font-size: 1.2em; }
            .template-actions { justify-content: center; } /* Center buttons on mobile */
            .template-actions .action-button { padding: 8px 14px; font-size: 0.85em; }
            .template-code-preview { white-space: normal; height: auto; max-height: 4em; } /* Allow wrap for small screens */

            .saved-query-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                padding: 15px 20px;
            }
            .saved-query-item .query-title,
            .saved-query-item .query-engine,
            .saved-query-item .query-text {
                flex-basis: auto;
                width: 100%;
                min-width: auto;
            }
            .saved-query-item .query-actions {
                margin-left: 0;
                width: 100%;
                justify-content: flex-end;
            }
            .saved-queries-controls { flex-direction: column; gap: 10px; }

            .query-diff-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .conversion-actions {
                transform: rotate(90deg);
                padding: 0;
            }
            .conversion-actions button {
                transform: rotate(-90deg);
                padding: 15px 20px;
                min-width: 50px; min-height: 50px;
            }
            .conversion-actions .icon-arrow-right::before { font-size: 1.4em; }
            .source-query-input textarea, .target-query-output textarea { min-height: 120px; }

            .generated-dork-output { padding: 20px; }
            #generated-dork-title { font-size: 1.6em; }
            .generator-controls { flex-direction: column; align-items: stretch; gap: 10px; }
            .generator-controls select { width: 100%; }

            #compatibility-table th, #compatibility-table td {
                padding: 10px 12px;
                font-size: 0.8em;
            }
            #compatibility-table { min-width: 500px; } /* Allow more horizontal scroll for this table */

            .analytics-charts-container .chart-card { padding: 18px; }

            .setting-group { margin-bottom: 25px; padding-bottom: 15px; }
            .setting-group h2 { font-size: 1.5em; }
            .setting-group label { flex-basis: auto; width: 100%; margin-bottom: 5px;}
            .setting-group input[type="password"], .setting-group select { max-width: 100%; }
            .setting-group div { flex-direction: column; align-items: flex-start; gap: 5px; }

            .toast { min-width: unset; max-width: 90%; margin: 0 auto; padding: 15px 20px; }
            #toast-container { right: 15px; bottom: 15px; left: 15px; align-items: center; }
        }

        /* Small devices (tablets, 481px to 768px) */
        @media (min-width: 481px) and (max-width: 768px) {
            #top-nav { padding: 0 20px; }
            .app-title { display: none; }
            .global-search-container { width: 300px; }

            #left-sidebar {
                width: 80px; /* Collapsed icon-only sidebar */
                overflow-x: hidden;
                padding-top: 20px;
            }
            #left-sidebar .nav-text {
                display: none;
            }
            #left-sidebar .nav-item a {
                justify-content: center;
                padding: 12px 0;
                border-radius: 50%; /* Circular for collapsed state */
                width: 60px; /* Fixed width */
                height: 60px; /* Fixed height */
                margin: 0 auto 8px auto; /* Center items */
            }
            #left-sidebar .nav-item a .icon {
                margin-right: 0;
                font-size: 1.5em; /* Larger icons in collapsed state */
            }
            #left-sidebar .nav-item.active a {
                box-shadow: 0 0 0 3px var(--accent-color); /* Circular glow */
            }

            #app-content {
                margin-left: 80px;
                padding: 80px 25px 25px 25px;
            }

            .summary-cards-container {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Adapt min-width */
                gap: 20px;
            }
            .summary-card p.small-text { font-size: 0.95em; } /* Adjust for tablet */


            .template-actions { justify-content: center; } /* Center buttons on mobile */
            .template-code-preview { white-space: normal; height: auto; max-height: 4em; } /* Allow wrap for small screens */


            .query-diff-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            .conversion-actions {
                transform: rotate(90deg);
                padding: 0;
            }
            .conversion-actions button {
                transform: rotate(-90deg);
                padding: 15px 25px; /* Adjust button padding */
                min-width: 55px; min-height: 55px;
            }
            .conversion-actions .icon-arrow-right::before { font-size: 1.5em; }

            .setting-group div { flex-direction: column; align-items: flex-start; gap: 8px;}
            .setting-group label { width: 100%; flex-basis: auto;}
        }

        /* Medium devices (desktops, 769px to 992px) */
        @media (min-width: 769px) and (max-width: 992px) {
            #top-nav { padding: 0 25px; }
            .global-search-container { width: 400px; }
            #left-sidebar { width: 220px; } /* Slightly narrower sidebar */
            #app-content { margin-left: 220px; }
            .query-diff-container { grid-template-columns: 1fr auto 1fr; }
            .conversion-actions { transform: none; padding: 0; }
            .conversion-actions button { transform: none; padding: 12px 25px; min-width: unset; min-height: unset; border-radius: 8px;}
            .conversion-actions .icon-arrow-right::before { font-size: 1.2em; }
        }
    </style>
</head>
<body class="dark-mode"> <!-- Changed default to dark-mode -->
    <header id="top-nav">
        <div class="nav-left">
            <div class="app-logo-title" data-nav-target="dashboard">
                <svg class="app-logo" xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='currentColor' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15H9v-2h2v2zm0-4H9V7h2v6zm4 0h-2V7h2v6z'/></svg>
                <span class="app-title">SearchSploit X</span>
            </div>
        </div>
        <div class="nav-center">
            <div class="global-search-container">
                <input type="text" id="global-search-input" placeholder="Search queries, templates, categories...">
                <button id="global-search-button" aria-label="Global Search">
                    <span class="icon icon-search"></span>
                </button>
            </div>
        </div>
        <div class="nav-right">
            <button id="theme-toggle" class="icon-theme-toggle" aria-label="Toggle Dark/Light Mode">
                <span class="icon icon-sun"></span>
                <span class="icon icon-moon"></span>
            </button>
            <div class="notification-dropdown">
                <button id="notifications-button" aria-label="Notifications">
                    <span class="icon icon-notifications"></span>
                    <span class="notification-badge" id="notification-count">3</span>
                </button>
                <div class="dropdown-content" id="notifications-content">
                    <a href="#">New templates added!</a>
                    <a href="#">Shodan API key expiring.</a>
                    <a href="#">Weekly usage report ready.</a>
                </div>
            </div>
            <div class="user-profile-dropdown">
                <button id="user-profile-button" class="user-avatar" aria-label="User Profile">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzQ2ODRkNSIgZD0iTTEyIDRjMi4yMSAwIDQgMS43OSA0IDRTMTQuMjEgMTIgMTIgMTJzLTQgMS43OS00IDRTOS43OSAxNiAxMiAxNiYjMTA7YzIuMDkgMCAzLjg1LTEuNTcgMy45OC0zLjY2QzE2Ljg3IDEyLjQ2IDE4LjA0IDEyIDExLjYzIDEyJiMxMDtMNiAxMnYxMmMwIC41NS0uNDUgMS0xIDFTNCgyMi41NSAzIDIyVjljMCAtLjU1LjQ1LTEgMS0xczEgLjQ1IDExIDAuNjMgMy4yOC41IDMuOTggMi4zNEMxOS44NSAxNC40MyAyMiAxNi4xOSAyMiAxNi4xOS43NyAyMCAyMiAyMi42MyAyMiAyMi43MSAyMy4xNiAyNCAtMSAyNC0yIDI0em0wLThjLjU1IDAgMS0uNDUgMS0xcy0uNDUtMS0xLTFzLTEgLjQ1LTEgMSAuNDUgMSAx IDF6Ii8+PC9zdmc+" alt="User Avatar">
                </button>
                <div class="dropdown-content" id="user-profile-content">
                    <a href="#" data-nav-target="settings">API Keys & Settings</a>
                    <a href="#" data-nav-target="help">Help & Support</a>
                    <a href="#" data-nav-target="logout">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <nav id="left-sidebar">
        <ul>
            <li class="nav-item active" data-module="dashboard">
                <a href="#dashboard">
                    <span class="icon icon-dashboard"></span>
                    <span class="nav-text">Dashboard</span>
                </a>
            </li>
            <li class="nav-item" data-module="query-builder">
                <a href="#query-builder">
                    <span class="icon icon-builder"></span>
                    <span class="nav-text">Query Builder</span>
                </a>
            </li>
            <li class="nav-item" data-module="template-library">
                <a href="#template-library">
                    <span class="icon icon-library"></span>
                    <span class="nav-text">Template Library</span>
                </a>
            </li>
            <li class="nav-item" data-module="saved-queries">
                <a href="#saved-queries">
                    <span class="icon icon-save"></span>
                    <span class="nav-text">Saved Queries</span>
                </a>
            </li>
            <li class="nav-item" data-module="query-converter">
                <a href="#query-converter">
                    <span class="icon icon-convert"></span>
                    <span class="nav-text">Query Converter</span>
                </a>
            </li>
            <li class="nav-item" data-module="random-query-lab">
                <a href="#random-query-lab">
                    <span class="icon icon-random"></span>
                    <span class="nav-text">Random Query Lab</span>
                </a>
            </li>
            <li class="nav-item" data-module="wayback-machine">
                <a href="#wayback-machine">
                    <span class="icon icon-wayback"></span>
                    <span class="nav-text">Wayback Machine</span>
                </a>
            </li>
            <li class="nav-item" data-module="engine-compatibility">
                <a href="#engine-compatibility">
                    <span class="icon icon-matrix"></span>
                    <span class="nav-text">Engine Compatibility Matrix</span>
                </a>
            </li>
            <li class="nav-item" data-module="analytics">
                <a href="#analytics">
                    <span class="icon icon-analytics"></span>
                    <span class="nav-text">Analytics & Usage</span>
                </a>
            </li>
            <li class="nav-item" data-module="settings">
                <a href="#settings">
                    <span class="icon icon-settings"></span>
                    <span class="nav-text">Settings</span>
                </a>
            </li>
            <li class="nav-item" data-module="help">
                <a href="#help">
                    <span class="icon icon-help"></span>
                    <span class="nav-text">Legal & Help</span>
                </a>
            </li>
        </ul>
    </nav>

    <main id="app-content">
        <section id="dashboard" class="module-content active">
            <h1>Dashboard</h1>
            <div class="summary-cards-container">
                <div class="summary-card">
                    <h3>Total Queries Executed</h3>
                    <p id="total-queries">0</p>
                </div>
                <div class="summary-card">
                    <h3>Engines Used</h3>
                    <p id="engines-used">0</p>
                </div>
                <div class="summary-card">
                    <h3>Top Templates</h3>
                    <p id="top-templates">N/A</p>
                </div>
                <div class="summary-card">
                    <h3>Saved Items</h3>
                    <p id="saved-items">0</p>
                </div>
                <div class="summary-card"> <!-- New Card -->
                    <h3>Average Query Length</h3>
                    <p id="avg-query-length">0</p>
                </div>
                <div class="summary-card"> <!-- New Card -->
                    <h3>Most Active Day</h3>
                    <p id="most-active-day">N/A</p>
                </div>
                <div class="summary-card"> <!-- New Card -->
                    <h3>Last Query Time</h3>
                    <p id="last-query-time" class="small-text">N/A</p>
                </div>
            </div>

            <div class="dashboard-section">
                <h2>Last 7 Days Activity</h2>
                <div class="chart-container">
                    <canvas id="activity-chart"></canvas>
                </div>
            </div>

            <div class="dashboard-section quick-actions">
                <h2>Quick Actions</h2>
                <button class="action-button" id="start-new-query" data-nav-target="query-builder">Start New Query</button>
                <button class="action-button secondary" id="import-template" data-nav-target="template-library">Import Template</button>
                <button class="action-button secondary" id="run-diagnostic">Run Diagnostic</button>
            </div>
        </section>

        <section id="query-builder" class="module-content">
            <h1>Advanced Query Builder</h1>
            <p style="margin-bottom: 20px; color: var(--text-secondary);">Build complex dork queries step-by-step using structured operators.</p>
            <div class="query-builder-controls">
                <label for="engine-selector">Select Engine:</label>
                <select id="engine-selector">
                    <option value="google">Google</option>
                    <option value="shodan">Shodan</option>
                    <option value="censys">Censys</option>
                    <option value="yandex">Yandex</option>
                    <option value="duckduckgo">DuckDuckGo</option>
                </select>
                <div class="query-builder-mode-toggle">
                    <button id="structured-mode-btn" class="active">Structured</button>
                    <button id="manual-mode-btn">Manual</button>
                </div>
            </div>

            <div id="structured-query-fields">
                <!-- Dynamic query fields will be added here -->
            </div>
            <button id="add-operator-button" class="action-button secondary add-operator-button">
                <span class="icon">➕</span> Add Operator
            </button>

            <textarea id="manual-query-input" placeholder="Enter your dork query here... (e.g., inurl:admin site:example.com)" spellcheck="false" style="display: none;"></textarea>

            <div id="query-linter-feedback" class="linter-feedback"></div>

            <div class="query-preview-container">
                <h2>Live Query Preview</h2>
                <p id="live-query-preview">Your constructed search query will appear here.</p>
                <button class="copy-button" id="copy-live-query-button"><span class="icon icon-copy"></span>Copy</button>
            </div>

            <div class="query-actions">
                <button id="execute-query" class="action-button">Execute</button>
                <button id="execute-run-query" class="action-button">Execute & Run</button>
                <button id="save-query" class="action-button secondary">Save</button>
                <button id="convert-query" class="action-button secondary">Convert</button>
            </div>
        </section>

        <section id="template-library" class="module-content">
            <h1>Template Library</h1>
            <div class="filter-search-bar">
                <input type="text" id="template-search" placeholder="Search templates by title, description, or tags...">
                <div class="filter-panel">
                    <select id="filter-category">
                        <option value="">All Categories</option>
                        <option value="config-leaks">Config Leaks</option>
                        <option value="directories">Directories</option>
                        <option value="login-portals">Login Portals</option>
                        <option value="cves">CVEs & Exploits</option>
                        <option value="exposed-databases">Exposed Databases</option>
                        <option value="cloud-assets">Cloud Assets</option>
                        <option value="iot">IoT Devices</option>
                        <option value="network-devices">Network Devices</option>
                        <option value="sensitive-data">Sensitive Data</option>
                        <option value="uncategorized">Uncategorized</option>
                    </select>
                    <select id="filter-engine">
                        <option value="">All Engines</option>
                        <option value="google">Google</option>
                        <option value="shodan">Shodan</option>
                        <option value="censys">Censys</option>
                        <option value="yandex">Yandex</option>
                        <option value="duckduckgo">DuckDuckGo</option>
                    </select>
                    <select id="filter-risk">
                        <option value="">All Risks</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                    <button id="filter-favorites-button" class="action-button secondary">
                        <span class="icon icon-favorite"></span>
                        Show Favorites
                    </button>
                </div>
            </div>

            <div class="template-view-toggle">
                <button id="card-view-btn" class="active"><span class="icon icon-card-view"></span>Card View</button>
                <button id="list-view-btn"><span class="icon icon-list-view"></span>List View</button>
            </div>

            <div class="template-cards-container" id="template-cards-container">
                </div>
            <div class="template-list-container" id="template-list-container">
                <table>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Description</th>
                            <th>Query Snippet</th> <!-- New Column -->
                            <th>Engines</th>
                            <th>Risk</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </section>

        <section id="saved-queries" class="module-content">
            <h1>Saved Queries</h1>
            <div class="saved-queries-controls">
                <button id="export-queries" class="action-button secondary">Export All (JSON)</button>
                <input type="file" id="import-queries-input" accept=".json" style="display: none;">
                <button id="import-queries-button" class="action-button secondary">Import (JSON)</button>
            </div>
            <div class="saved-queries-list" id="saved-queries-list">
                <p style="text-align: center; color: var(--text-secondary);" id="no-saved-queries-message">No saved queries yet. Save a query from the Query Builder!</p>
            </div>
        </section>

        <section id="query-converter" class="module-content">
            <h1>Query Converter Engine</h1>
            <div class="converter-selectors">
                <label for="source-engine">From:</label>
                <select id="source-engine">
                    <option value="google">Google</option>
                    <option value="shodan">Shodan</option>
                    <option value="censys">Censys</option>
                    <option value="yandex">Yandex</option>
                    <option value="duckduckgo">DuckDuckGo</option>
                </select>
                <label for="target-engine">To:</label>
                <select id="target-engine">
                    <option value="shodan">Shodan</option>
                    <option value="google">Google</option>
                    <option value="censys">Censys</option>
                    <option value="yandex">Yandex</option>
                    <option value="duckduckgo">DuckDuckGo</option>
                </select>
            </div>

            <div class="query-diff-container">
                <div class="source-query-input">
                    <textarea id="source-query-editor" placeholder="Enter query to convert..."></textarea>
                </div>
                <div class="conversion-actions">
                    <button id="convert-button">Convert <span class="icon icon-arrow-right"></span></button>
                </div>
                <div class="target-query-output">
                    <textarea id="target-query-output" readonly placeholder="Converted query will appear here..."></textarea>
                </div>
            </div>

            <div class="conversion-feedback" id="conversion-feedback">
                </div>
        </section>

        <section id="random-query-lab" class="module-content">
            <h1>Random Dork Generator</h1>
            <p>Generate a random dork based on category and engine for quick exploration or inspiration.</p>
            <div class="generator-controls">
                <label for="generator-engine">Lock to Engine:</label>
                <select id="generator-engine">
                    <option value="">Any</option>
                    <option value="google">Google</option>
                    <option value="shodan">Shodan</option>
                    <option value="censys">Censys</option>
                    <option value="yandex">Yandex</option>
                    <option value="duckduckgo">DuckDuckGo</option>
                </select>
                <label for="generator-category">Lock to Category:</label>
                <select id="generator-category">
                    <option value="">Any</option>
                    <option value="config-leaks">Config Leaks</option>
                    <option value="directories">Directories</option>
                    <option value="login-portals">Login Portals</option>
                    <option value="cves">CVEs & Exploits</option>
                    <option value="exposed-databases">Exposed Databases</option>
                    <option value="cloud-assets">Cloud Assets</option>
                    <option value="iot">IoT Devices</option>
                    <option value="network-devices">Network Devices</option>
                    <option value="sensitive-data">Sensitive Data</option>
                    <option value="uncategorized">Uncategorized</option>
                </select>
                <button id="generate-dork" class="action-button">Generate Another Dork</button>
            </div>

            <div class="generated-dork-output">
                <h2 id="generated-dork-title">Click "Generate Another Dork" to get started!</h2>
                <p id="generated-dork-description">A powerful, randomly generated dork will be displayed here based on your selected filters.</p>
                <pre id="generated-dork-query">_your_generated_dork_will_appear_here_</pre>
                <div class="generated-dork-actions">
                    <button id="copy-generated-dork" class="action-button secondary"><span class="icon icon-copy"></span>Copy Dork</button>
                    <button id="auto-run-dork" class="action-button" disabled>Auto-Run</button>
                    <button id="review-dork" class="action-button secondary" disabled>Review in Builder</button>
                    <button id="add-to-saved-dork" class="action-button secondary" disabled>Add to Saved</button>
                </div>
            </div>
        </section>

        <section id="wayback-machine" class="module-content">
            <h1>Wayback Machine Lookup</h1>
            <p style="margin-bottom: 20px; color: var(--text-secondary);">Retrieve archived versions of any website using the Internet Archive's Wayback Machine.</p>
            <div class="input-group" style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                <label for="wayback-url" style="font-weight: 600; color: var(--text-primary); align-self: center;">Enter URL:</label>
                <input type="text" id="wayback-url" placeholder="e.g., https://example.com" style="flex-grow: 1; min-width: 250px;">
                <button id="lookup-wayback" class="action-button">Lookup Archive</button>
            </div>
            <div id="wayback-result-container" class="query-preview-container" style="display: none;">
                <h2>Archived Versions Link</h2>
                <p id="wayback-result-link">
                    <a href="#" target="_blank" rel="noopener noreferrer">Click here to view archive for <span id="wayback-display-url"></span></a>
                </p>
                <button class="copy-button" id="copy-wayback-link-button"><span class="icon icon-copy"></span>Copy Link</button>
            </div>
            <div id="wayback-feedback" class="linter-feedback"></div>
        </section>

        <section id="engine-compatibility" class="module-content">
            <h1>Engine Compatibility Matrix</h1>
            <p style="margin-bottom: 20px; color: var(--text-secondary);">This matrix outlines the supported operators and syntax for each search engine, highlighting differences and limitations.</p>
            <div class="compatibility-table-container">
                <table id="compatibility-table">
                    <thead>
                        <tr>
                            <th>Operator/Syntax</th>
                            <th>Google</th>
                            <th>Shodan</th>
                            <th>Censys</th>
                            <th>Yandex</th>
                            <th>DuckDuckGo</th>
                            <th>Notes/Limitations</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
            <div class="engine-docs-links">
                <h2>Official Documentation:</h2>
                <ul>
                    <li><a href="https://support.google.com/websearch/answer/2466433?hl=en" target="_blank" rel="noopener noreferrer">Google Search Operators</a></li>
                    <li><a href="https://docs.shodan.io/search-filters" target="_blank" rel="noopener noreferrer">Shodan Search Filters</a></li>
                    <li><a href="https://docs.censys.io/v1/search/overview" target="_blank" rel="noopener noreferrer">Censys Search Overview</a></li>
                    <li><a href="https://yandex.com/support/search/query-language.html" target="_blank" rel="noopener noreferrer">Yandex Query Language</a></li>
                    <li><a href="https://duckduckgo.com/bang" target="_blank" rel="noopener noreferrer">DuckDuckGo Bangs/Syntax</a></li>
                </ul>
            </div>
        </section>

        <section id="analytics" class="module-content">
            <h1>Analytics & Usage History</h1>
            <p>Track your query usage and trends across different search engines and categories.</p>
            <div class="analytics-controls" style="margin-bottom: 25px;">
                <label for="analytics-date-range">Time Period:</label>
                <select id="analytics-date-range">
                    <option value="7">Last 7 Days</option>
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="all">All Time</option>
                </select>
                <button id="download-usage-csv" class="action-button secondary"><span class="icon icon-save"></span>Download Usage Report (CSV)</button>
                <button id="download-usage-pdf" class="action-button secondary" disabled><span class="icon icon-save"></span>Download Usage Report (PDF)</button>
            </div>
            <div class="analytics-charts-container">
                <div class="chart-card">
                    <h2>Top Used Engines</h2>
                    <canvas id="top-engines-chart"></canvas>
                </div>
                <div class="chart-card">
                    <h2>Top Dork Categories</h2>
                    <canvas id="top-categories-chart"></canvas>
                </div>
                <div class="chart-card">
                    <h2>Successful Executions Over Time</h2>
                    <canvas id="successful-executions-chart"></canvas>
                </div>
            </div>
        </section>

        <section id="settings" class="module-content">
            <h1>Settings</h1>
            <div class="setting-group">
                <h2>API Keys</h2>
                <p>Manage API keys for integrated services. These are stored locally in your browser and are not sent to any server. Keep them secure!</p>
                <div>
                    <label for="shodan-api-key">Shodan API Key:</label>
                    <input type="password" id="shodan-api-key" placeholder="Enter Shodan API key">
                    <button id="save-shodan-key" class="action-button secondary">Save</button>
                </div>
                <div style="margin-top: 15px;">
                    <label for="censys-api-key">Censys API Key:</label>
                    <input type="password" id="censys-api-key" placeholder="Enter Censys API key">
                    <button id="save-censys-key" class="action-button secondary">Save</button>
                </div>
            </div>
            <div class="setting-group">
                <h2>Application Preferences</h2>
                <p>Customize your SearchSploit X experience.</p>
                <div>
                    <label for="default-engine">Default Query Engine:</label>
                    <select id="default-engine">
                        <option value="google">Google</option>
                        <option value="shodan">Shodan</option>
                        <option value="censys">Censys</option>
                        <option value="yandex">Yandex</option>
                        <option value="duckduckgo">DuckDuckGo</option>
                    </select>
                </div>
            </div>
        </section>

        <section id="help" class="module-content">
            <h1>Legal & Help</h1>
            <div class="legal-disclaimer">
                <p><strong>Disclaimer:</strong> This toolkit is strictly intended for legal, authorized research and educational use only. Do not use it to access or scan systems you do not own or have explicit permission to test.</p>
            </div>
            <div class="help-content">
                <h2>Help Resources</h2>
                <ul>
                    <li><a href="#">Frequently Asked Questions (FAQ)</a></li>
                    <li><a href="#">User Manual (Coming Soon)</a></li>
                    <li><a href="#">Contact Support</a></li>
                    <li><a href="#">Report an Issue</a></li>
                </ul>
            </div>
        </section>
    </main>

    <div id="toast-container"></div>

    <div id="saveQueryModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3>Save Query</h3>
            <label for="save-query-name">Query Name:</label>
            <input type="text" id="save-query-name" placeholder="Enter a name for your query">
            <div class="modal-buttons">
                <button class="action-button secondary modal-cancel-btn">Cancel</button>
                <button class="action-button modal-save-confirm-btn">Save</button>
            </div>
        </div>
    </div>

    <div id="confirmDeleteModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3>Confirm Deletion</h3>
            <p id="confirm-delete-message">Are you sure you want to delete this query?</p>
            <div class="modal-buttons">
                <button class="action-button secondary modal-cancel-btn">Cancel</button>
                <button class="action-button modal-delete-confirm-btn">Delete</button>
            </div>
        </div>
    </div>

    <div id="templateDetailModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 id="template-modal-title">Template Details</h3>
            <p id="template-modal-description" style="margin-bottom: 10px;"></p>
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                <span id="template-modal-engines" class="compatibility-icons"></span>
                <span id="template-modal-risk" class="risk-level"></span>
            </div>
            <label>Query String (Command Line Format):</label>
            <textarea id="template-modal-query" class="query-preview" readonly></textarea>
            <div class="modal-buttons">
                <button class="action-button secondary" id="template-modal-copy-btn"><span class="icon icon-copy"></span>Copy Query</button>
                <button class="action-button secondary" id="template-modal-customize-btn">Customize in Builder</button>
                <button class="action-button" id="template-modal-use-now-btn">Use Now & Run</button>
            </div>
        </div>
    </div>

    <script>
        // --- Core Application Data & State ---
        const appState = {
            activeModule: localStorage.getItem('activeModule') || 'dashboard',
            theme: localStorage.getItem('theme') || 'dark-mode', // Changed default to dark-mode
            savedQueries: JSON.parse(localStorage.getItem('savedQueries')) || [],
            usageHistory: JSON.parse(localStorage.getItem('usageHistory')) || [],
            apiKeys: JSON.parse(localStorage.getItem('apiKeys')) || { shodan: '', censys: '' },
            defaultEngine: localStorage.getItem('defaultEngine') || 'google',
            templateView: localStorage.getItem('templateView') || 'card-view', // 'card-view' or 'list-view'
            filterFavorites: localStorage.getItem('filterFavorites') === 'true' || false,
            queryBuilderMode: localStorage.getItem('queryBuilderMode') || 'structured', // 'structured' or 'manual'
            queryBuilderFields: JSON.parse(localStorage.getItem('queryBuilderFields')) || [{ id: 'field-0', operator: 'keyword', value: '' }],
            queryBuilderEngine: localStorage.getItem('queryBuilderEngine') || 'google', // Track engine for structured builder
        };

        const searchEngineUrls = {
            google: 'https://www.google.com/search?q=',
            shodan: 'https://www.shodan.io/search?query=',
            censys: 'https://search.censys.io/search?resource=hosts&q=',
            yandex: 'https://yandex.com/search/?text=',
            duckduckgo: 'https://duckduckgo.com/?q='
        };

        // --- New: Query Builder Operators & Definitions ---
        const queryOperators = {
            google: [
                { id: 'keyword', label: 'Keyword', type: 'text', placeholder: 'e.g., "admin panel"', prefix: '' },
                { id: 'site', label: 'Site', type: 'text', placeholder: 'e.g., example.com', prefix: 'site:' },
                { id: 'inurl', label: 'InURL', type: 'text', placeholder: 'e.g., /admin', prefix: 'inurl:' },
                { id: 'intitle', label: 'InTitle', type: 'text', placeholder: 'e.g., "Index of"', prefix: 'intitle:' },
                { id: 'filetype', label: 'Filetype', type: 'text', placeholder: 'e.g., pdf, docx', prefix: 'filetype:' },
                { id: 'or', label: 'OR', type: 'text', placeholder: 'term1 OR term2', prefix: 'OR ' },
                { id: 'and', label: 'AND', type: 'text', placeholder: 'AND term2', prefix: 'AND ' },
                { id: 'exclude', label: 'Exclude', type: 'text', placeholder: 'e.g., -test', prefix: '-' }
            ],
            shodan: [
                { id: 'keyword', label: 'Keyword', type: 'text', placeholder: 'e.g., "nginx"', prefix: '' },
                { id: 'port', label: 'Port', type: 'text', placeholder: 'e.g., 22, 8080', prefix: 'port:' },
                { id: 'country', label: 'Country', type: 'text', placeholder: 'e.g., US, DE', prefix: 'country:' },
                { id: 'product', label: 'Product', type: 'text', placeholder: 'e.g., Apache, Nginx', prefix: 'product:' },
                { id: 'org', label: 'Organization', type: 'text', placeholder: 'e.g., Microsoft', prefix: 'org:' },
                { id: 'http.title', label: 'HTTP Title', type: 'text', placeholder: 'e.g., "Login"', prefix: 'http.title:' },
                { id: 'http.url', label: 'HTTP URL', type: 'text', placeholder: 'e.g., /dashboard', prefix: 'http.url:' },
                { id: 'ip', label: 'IP Address', type: 'text', placeholder: 'e.g., 192.168.1.1', prefix: 'ip:' },
                { id: 'after', label: 'After Date', type: 'text', placeholder: 'YYYY-MM-DD', prefix: 'after:' },
                { id: 'before', label: 'Before Date', type: 'text', placeholder: 'YYYY-MM-DD', prefix: 'before:' },
            ],
            censys: [
                { id: 'keyword', label: 'Keyword', type: 'text', placeholder: 'e.g., "SSH"', prefix: '' },
                { id: 'services.port', label: 'Service Port', type: 'text', placeholder: 'e.g., 22, 443', prefix: 'services.port:' },
                { id: 'location.country_code', label: 'Country Code', type: 'text', placeholder: 'e.g., US, GB', prefix: 'location.country_code:' },
                { id: 'software.product', label: 'Software Product', type: 'text', placeholder: 'e.g., OpenSSH', prefix: 'software.product:' },
                { id: 'services.web.host', label: 'Web Host', type: 'text', placeholder: 'e.g., example.com', prefix: 'services.web.host:' },
                { id: 'title', label: 'Title', type: 'text', placeholder: 'e.g., "Dashboard"', prefix: 'title:' },
                { id: 'services.web.page.url', label: 'Page URL', type: 'text', placeholder: 'e.g., /login', prefix: 'services.web.page.url:' },
                { id: 'ip', label: 'IP Address', type: 'text', placeholder: 'e.g., 8.8.8.8', prefix: 'ip:' },
                { id: 'protocols', label: 'Protocol', type: 'text', placeholder: 'e.g., "23/telnet"', prefix: 'protocols:' },
            ],
            yandex: [
                { id: 'keyword', label: 'Keyword', type: 'text', placeholder: 'e.g., "password"', prefix: '' },
                { id: 'site', label: 'Site', type: 'text', placeholder: 'e.g., example.org', prefix: 'site:' },
                { id: 'inurl', label: 'InURL', type: 'text', placeholder: 'e.g., /config', prefix: 'inurl:' },
                { id: 'intitle', label: 'InTitle', type: 'text', placeholder: 'e.g., "report"', prefix: 'intitle:' },
                { id: 'filetype', label: 'Filetype', type: 'text', placeholder: 'e.g., xls, doc', prefix: 'filetype:' },
                { id: 'lang', label: 'Language', type: 'text', placeholder: 'e.g., en, ru', prefix: 'lang:' },
            ],
            duckduckgo: [
                { id: 'keyword', label: 'Keyword', type: 'text', placeholder: 'e.g., "secret key"', prefix: '' },
                { id: 'site', label: 'Site', type: 'text', placeholder: 'e.g., mysite.com', prefix: 'site:' },
                { id: 'inurl', label: 'InURL', type: 'text', placeholder: 'e.g., /backup', prefix: 'inurl:' },
                { id: 'intitle', label: 'InTitle', type: 'text', placeholder: 'e.g., "restricted"', prefix: 'intitle:' },
                { id: 'filetype', label: 'Filetype', type: 'text', placeholder: 'e.g., txt, json', prefix: 'filetype:' },
                { id: 'bang', label: 'Bang (!)', type: 'text', placeholder: 'e.g., !g, !w', prefix: '' }, // Special for DDG
            ]
        };

        // --- Mock Data for Templates (Example of ~10 templates, can be expanded to 7000+) ---
        // For 7000+ templates, you'd load this from a JSON file via Fetch API or embed directly
        // and implement more advanced data handling if performance is critical (e.g., lazy loading).
        const mockTemplateData = [
            { id: 'tpl-nginx-001', title: 'Exposed Nginx Configs', description: 'Finds publicly accessible Nginx configuration files that might contain sensitive server paths or backend IPs. A critical information disclosure vulnerability.', category: 'config-leaks', engineSupport: ['google', 'yandex', 'duckduckgo'], tags: ['exposure', 'sensitive', 'recon', 'nginx', 'config'], riskLevel: 'High', queryString: 'intitle:"index of" "nginx.conf" OR inurl:"nginx.conf" site:github.com' },
            { id: 'tpl-rdp-001', title: 'Censys: Exposed RDP', description: 'Identifies systems with exposed Remote Desktop Protocol (RDP) services on Censys, indicating potential attack surface. Often leads to brute-force attacks.', category: 'login-portals', engineSupport: ['censys'], tags: ['exposure', 'vulnerability', 'remote-access', 'rdp', 'microsoft'], riskLevel: 'High', queryString: 'protocols:"3389/rdp" AND services.port:3389' },
            { id: 'tpl-env-001', title: '.env File Exposure', description: 'Searches for exposed .env files which often contain database credentials, API keys, and other critical environment variables. A severe data leak risk.', category: 'config-leaks', engineSupport: ['google', 'yandex', 'duckduckgo'], tags: ['exposure', 'sensitive', 'data-leak', 'env', 'api-key'], riskLevel: 'High', queryString: 'inurl:".env" AND "APP_KEY" filetype:env' },
            { id: 'tpl-jenkins-001', title: 'Shodan: Jenkins Login', description: 'Discovers Jenkins CI/CD servers with publicly accessible login pages, potentially indicating unauthenticated instances or default credentials. A common target for compromise.', category: 'login-portals', engineSupport: ['shodan'], tags: ['exposure', 'login', 'ci/cd', 'jenkins'], riskLevel: 'Medium', queryString: 'http.title:"Jenkins" "login" country:US' },
            { id: 'tpl-mysql-001', title: 'Exposed MySQL (Shodan)', description: 'Finds MySQL databases exposed directly to the internet, a critical misconfiguration that allows unauthorized access to data.', category: 'exposed-databases', engineSupport: ['shodan'], tags: ['exposure', 'database', 'vulnerability', 'mysql'], riskLevel: 'High', queryString: 'port:3306 product:"MySQL"' },
            { id: 'tpl-s3-bucket-001', title: 'Open S3 Buckets (Google)', description: 'Identifies publicly accessible Amazon S3 buckets that may contain sensitive data due to misconfigured permissions. High impact data breach risk.', category: 'cloud-assets', engineSupport: ['google', 'duckduckgo'], tags: ['exposure', 'cloud', 'data-leak', 'aws', 's3'], riskLevel: 'High', queryString: 'site:s3.amazonaws.com inurl:list-files "example.com"' },
            { id: 'tpl-phpinfo-001', title: 'PHP Info Pages', description: 'Discovers web pages containing phpinfo() output, which often reveals extensive server configuration and sensitive data. Information disclosure risk.', category: 'config-leaks', engineSupport: ['google', 'yandex', 'duckduckgo'], tags: ['exposure', 'information-disclosure', 'php'], riskLevel: 'Medium', queryString: 'inurl:phpinfo.php OR inurl:test.php intitle:"phpinfo()" filetype:php' },
            { id: 'tpl-cve-log4j-001', title: 'Log4j Vulnerability (Shodan)', description: 'Searches for systems potentially vulnerable to Log4j (CVE-2021-44228) by identifying specific HTTP headers or banners. Indicates critical remote code execution vulnerability.', category: 'cves', engineSupport: ['shodan'], tags: ['cve', 'vulnerability', 'log4j', 'rce'], riskLevel: 'High', queryString: 'http.jndi:true' },
            { id: 'tpl-git-exposed-001', title: 'Exposed Git Repositories', description: 'Finds publicly accessible `.git` directories that can expose source code and sensitive commit history.', category: 'config-leaks', engineSupport: ['google', 'yandex', 'duckduckgo'], tags: ['exposure', 'source-code', 'git', 'version-control'], riskLevel: 'High', queryString: 'inurl:.git/HEAD intitle:"index of .git/HEAD"' },
            { id: 'tpl-webcam-001', title: 'Public Webcams (Google)', description: 'Discovers unsecured webcams accessible via public search engines, often due to default credentials or misconfiguration.', category: 'iot', engineSupport: ['google', 'yandex'], tags: ['exposure', 'privacy', 'iot', 'surveillance'], riskLevel: 'Low', queryString: 'intitle:"webcam 7" inurl:index.html' },
            { id: 'tpl-elastic-001', title: 'Exposed Elasticsearch', description: 'Identifies Elasticsearch instances exposed to the internet without authentication, allowing access to indexed data.', category: 'exposed-databases', engineSupport: ['shodan', 'censys'], tags: ['exposure', 'database', 'nosql', 'elasticsearch'], riskLevel: 'High', queryString: 'port:9200 "Elasticsearch HTTP" -authentication' },
            { id: 'tpl-network-device-001', title: 'Cisco Smart Install (Shodan)', description: 'Finds Cisco devices vulnerable to Smart Install abuse, allowing unauthenticated configuration changes.', category: 'network-devices', engineSupport: ['shodan'], tags: ['network', 'cisco', 'vulnerability', 'exposure'], riskLevel: 'High', queryString: 'port:47860 product:"Cisco Smart Install"' },
            { id: 'tpl-api-keys-001', title: 'Public API Keys', description: 'Searches for instances of exposed API keys in code repositories, configuration files, or public documents.', category: 'sensitive-data', engineSupport: ['google', 'duckduckgo'], tags: ['api-key', 'sensitive', 'exposure', 'security'], riskLevel: 'High', queryString: 'intext:"api_key" filetype:json OR filetype:txt site:github.com' },
            { id: 'tpl-sql-errors-001', title: 'SQL Error Messages', description: 'Finds web pages displaying verbose SQL error messages, which can reveal database structure and aid SQL injection attempts.', category: 'cves', engineSupport: ['google', 'yandex', 'duckduckgo'], tags: ['vulnerability', 'sqli', 'error', 'database'], riskLevel: 'Medium', queryString: 'intext:"SQL syntax error" OR intext:"ORA-00900" OR intext:"SELECT * FROM" filetype:php' },
            { id: 'tpl-iot-dash-001', title: 'IoT Device Dashboards', description: 'Discovers web interfaces for various IoT devices (e.g., routers, cameras, smart home hubs) potentially exposed to the internet.', category: 'iot', engineSupport: ['shodan', 'censys'], tags: ['iot', 'exposure', 'dashboard', 'control-panel'], riskLevel: 'Medium', queryString: 'http.title:"IoT Dashboard" port:80,8080' },
            { id: 'tpl-admin-portals-001', title: 'Admin Login Portals', description: 'Generic search for common administration login pages across the web.', category: 'login-portals', engineSupport: ['google', 'duckduckgo', 'yandex'], tags: ['login', 'admin', 'panel', 'access'], riskLevel: 'Medium', queryString: 'inurl:admin OR inurl:login OR inurl:dashboard intitle:"Login" OR intitle:"Administration"' }
            // ...imagine 6990 more templates here...
        ];


        // --- Mock Data for Engine Compatibility Matrix ---
        const compatibilityData = [
            { operator: 'site:', google: '✔', shodan: '✘ (use hostname:)', censys: '✘ (use services.web.host:)', yandex: '✔', duckduckgo: '✔', notes: 'Limits search to a specific domain or host. Shodan/Censys require specific service fields.' },
            { operator: 'intitle:', google: '✔', shodan: '✔ (use http.title:)', censys: '✔ (use title:)', yandex: '✔', duckduckgo: '✔', notes: 'Searches for keywords in the page title.' },
            { operator: 'inurl:', google: '✔', shodan: '✘ (use http.url:)', censys: '✔ (use services.web.page.url:)', yandex: '✔', duckduckgo: '✔', notes: 'Searches for keywords in the URL.' },
            { operator: 'filetype:', google: '✔', shodan: '✘', censys: '✘', yandex: '✔', duckduckgo: '✔', notes: 'Limits results to specific file types. Not directly supported by Shodan/Censys.' },
            { operator: 'port:', google: '✘', shodan: '✔', censys: '✔ (use services.port:)', yandex: '✘', duckduckgo: '✘', notes: 'Specific to network scanners; identifies open ports. Not applicable to general web search engines.' },
            { operator: 'product:', google: '✘', shodan: '✔', censys: '✔ (use software.product:)', yandex: '✘', duckduckgo: '✘', notes: 'Searches for specific software products, often from banners/fingerprints.' },
            { operator: 'country:', google: '✘', shodan: '✔', censys: '✔ (use location.country_code:)', yandex: '✘', duckduckgo: '✘', notes: 'Filters results by geographical location.' },
            { operator: 'OR', google: '✔', shodan: '✔', censys: '✔', yandex: '✔', duckduckgo: '✔', notes: 'Boolean OR operator. Can be represented as | in some engines.' },
            { operator: 'AND', google: '✔', shodan: '✔', censys: '✔', yandex: '✔', duckduckgo: '✔', notes: 'Boolean AND operator. Often implied by spaces.' },
            { operator: '"exact phrase"', google: '✔', shodan: '✔', censys: '✔', yandex: '✔', duckduckgo: '✔', notes: 'Searches for an exact phrase.' },
            { operator: '-', google: '✔', shodan: '✔', censys: '✔ (use - or NOT)', yandex: '✔', duckduckgo: '✔', notes: 'Excludes terms/phrases.' },
            { operator: '*', google: '✔', shodan: '✘', censys: '✘', yandex: '✔', duckduckgo: '✔', notes: 'Wildcard. Not commonly supported in Shodan/Censys for general search.' },
            { operator: 'ip:', google: '✘', shodan: '✔', censys: '✔', yandex: '✘', duckduckgo: '✘', notes: 'Searches for specific IP addresses. Exclusive to network scanners.' },
            { operator: 'org:', google: '✘', shodan: '✔', censys: '✔', yandex: '✘', duckduckgo: '✘', notes: 'Filters by organization name (Shodan) or autonomous system (Censys).' },
            { operator: 'lang:', google: '✘', shodan: '✘', censys: '✘', yandex: '✔', duckduckgo: '✘', notes: 'Filters results by language.' },
            { operator: 'bang', google: '✘', shodan: '✘', censys: '✘', yandex: '✘', duckduckgo: '✔', notes: 'DuckDuckGo specific operator for quick searches on other sites (e.g., !wiki).' },
        ];


        // --- Global DOM Elements (Declared here, assigned in DOMContentLoaded) ---
        let structuredQueryFieldsContainer, addOperatorButton, manualQueryInput, liveQueryPreview, engineSelector, linterFeedback, copyLiveQueryButton;
        let structuredModeBtn, manualModeBtn; // Query Builder mode toggle buttons
        let templateCardsContainer, templateSearchInput, filterCategory, filterEngine, filterRisk, filterFavoritesButton;
        let templateListViewBtn, templateCardViewBtn, templateListTableBody;
        let savedQueriesList, noSavedQueriesMessage;
        let sourceQueryEditor, targetQueryOutput, convertButton, converterSourceEngine, converterTargetEngine, conversionFeedback;
        let generateDorkButton, generatorEngine, generatorCategory, generatedDorkTitle, generatedDorkDescription, generatedDorkQuery, copyGeneratedDorkButton, autoRunDorkButton, reviewDorkButton, addToSavedDorkButton;
        let waybackUrlInput, lookupWaybackButton, waybackResultContainer, waybackResultLink, waybackDisplayUrl, copyWaybackLinkButton, waybackFeedback;
        let compatibilityTableBody;
        let activityChartCtx, topEnginesChartCtx, topCategoriesChartCtx, successfulExecutionsChartCtx;
        let activityChartInstance, topEnginesChartInstance, topCategoriesChartInstance, successfulExecutionsChartInstance; // Chart.js instances
        let shodanApiKeyInput, censysApiKeyInput, defaultEngineSelect, analyticsDateRangeSelect;

        // Dashboard specific elements
        let avgQueryLengthDisplay, mostActiveDayDisplay, lastQueryTimeDisplay;


        // Modals
        let saveQueryModal, saveQueryNameInput, saveQueryConfirmBtn, saveQueryCancelBtn;
        let confirmDeleteModal, confirmDeleteMessage, confirmDeleteConfirmBtn, confirmDeleteCancelBtn;

        // Template Detail Modal elements (declared globally now)
        let templateDetailModal;
        let templateModalTitle;
        let templateModalDescription;
        let templateModalEngines;
        let templateModalRisk;
        let templateModalQuery;
        let templateModalCopyBtn;
        let templateModalCustomizeBtn;
        let templateModalUseNowBtn;


        // --- Utility Functions ---

        /**
         * Shows a transient toast notification.
         * @param {string} message - The message to display.
         * @param {'success' | 'error' | 'info'} type - Type of toast (influences color).
         * @param {number} duration - How long the toast stays visible in ms.
         */
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span class="toast-icon ${type}"></span><p>${message}</p>`; // Added icon
            container.appendChild(toast);

            // Force reflow to enable transition
            setTimeout(() => { toast.classList.add('show'); }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove(), { once: true });
            }, duration);
        }

        /**
         * Toggles the visibility of a dropdown menu.
         * @param {string} buttonId - ID of the button that triggers the dropdown.
         * @param {string} contentId - ID of the dropdown content element.
         */
        function setupDropdownToggle(buttonId, contentId) {
            const button = document.getElementById(buttonId);
            const content = document.getElementById(contentId);

            if (!button || !content) {
                console.warn(`Dropdown elements not found: button=${buttonId}, content=${contentId}`);
                return;
            }

            button.addEventListener('click', (event) => {
                event.stopPropagation();
                content.classList.toggle('show');
            });

            document.addEventListener('click', (event) => {
                if (!button.contains(event.target) && !content.contains(event.target)) {
                    content.classList.remove('show');
                }
            });
        }

        /**
         * Generic function to open a custom modal.
         * @param {HTMLElement} modalOverlay - The modal overlay DOM element.
         * @returns {Promise<boolean>} Resolves true if confirmed, false if cancelled.
         */
        function openModal(modalOverlay) {
            return new Promise((resolve) => {
                modalOverlay.classList.add('show');

                const confirmBtn = modalOverlay.querySelector('.modal-save-confirm-btn, .modal-delete-confirm-btn');
                const cancelBtn = modalOverlay.querySelector('.modal-cancel-btn');
                const closeBtn = modalOverlay.querySelector('.modal-close');

                const handleConfirm = () => {
                    modalOverlay.classList.remove('show');
                    cleanup();
                    resolve(true);
                };

                const handleCancel = () => {
                    modalOverlay.classList.remove('show');
                    cleanup();
                    resolve(false);
                };

                const cleanup = () => {
                    confirmBtn && confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn && cancelBtn.removeEventListener('click', handleCancel);
                    closeBtn && closeBtn.removeEventListener('click', handleCancel);
                    modalOverlay.removeEventListener('click', handleOverlayClick);
                };

                const handleOverlayClick = (event) => {
                    if (event.target === modalOverlay) {
                        handleCancel();
                    }
                };

                confirmBtn && confirmBtn.addEventListener('click', handleConfirm);
                cancelBtn && cancelBtn.addEventListener('click', handleCancel);
                closeBtn && closeBtn.addEventListener('click', handleCancel);
                modalOverlay.addEventListener('click', handleOverlayClick);
            });
        }

        /**
         * Generates the full search URL for a given query and engine.
         * @param {string} query - The dork query string.
         * @param {string} engine - The search engine name (e.g., 'google', 'shodan').
         * @returns {string} The full URL.
         */
        function generateQueryUrl(query, engine) {
            const baseUrl = searchEngineUrls[engine];
            return baseUrl ? baseUrl + encodeURIComponent(query) : '';
        }

        /**
         * Runs a linter check on the constructed query based on the selected engine.
         * Checks for basic syntax issues and operator compatibility.
         * @param {string} query - The full query string constructed from builder fields.
         * @param {string} engine - The selected search engine.
         * @param {Array<Object>} queryFields - The structured query fields for more specific linting.
         * @returns {string} 'none', 'warning', or 'error' indicating lint status.
         */
        function runQueryLinter(query, engine, queryFields) {
            let warnings = [];
            let errors = [];

            if (!query.trim()) {
                errors.push("Query cannot be empty.");
            }

            // If in manual mode, basic checks only
            if (appState.queryBuilderMode === 'manual') {
                if (query.includes('site:') && !queryOperators[engine].some(op => op.id === 'site' || op.prefix === 'site:')) {
                    warnings.push(`The 'site:' operator might not be compatible or requires different syntax for ${engine}.`);
                }
                // Add more generic manual mode checks if needed
            } else { // Structured mode, more detailed checks
                queryFields.forEach(field => {
                    if (field.value.trim() === '') return; // Skip empty fields

                    const operatorRule = compatibilityData.find(rule => rule.operator === (field.operator + ':') || rule.operator === field.operator || rule.operator.includes(field.operator));
                    if (operatorRule) {
                        const engineSupport = operatorRule[engine];
                        if (engineSupport && engineSupport.includes('✘')) {
                            warnings.push(`'${field.operator}:' operator might not be fully supported by ${engine}. ${operatorRule.notes}`);
                        } else if (engineSupport && engineSupport.includes('use')) {
                            warnings.push(`Consider using '${engineSupport.split('(')[1].replace(')','')}' syntax for '${field.operator}:' in ${engine}.`);
                        }
                    }
                });
            }


            if (errors.length > 0) {
                linterFeedback.innerHTML = `<strong>Errors:</strong><br>${errors.join('<br>')}`;
                linterFeedback.className = 'linter-feedback error active'; // Ensure 'active' is added
                linterFeedback.style.display = 'block';
                return 'error';
            } else if (warnings.length > 0) {
                linterFeedback.innerHTML = `<strong>Warnings:</strong><br>${warnings.join('<br>')}`;
                linterFeedback.className = 'linter-feedback warning active'; // Ensure 'active' is added
                linterFeedback.style.display = 'block';
                return 'warning';
            } else {
                linterFeedback.style.display = 'none';
                linterFeedback.className = 'linter-feedback'; // Reset class
                return 'none';
            }
        }

        /**
         * Manages the dynamic creation and updating of query input fields.
         * Stores the state of these fields in `appState.queryBuilderFields`.
         */
        function renderQueryBuilderFields() {
            structuredQueryFieldsContainer.innerHTML = '';
            const currentEngineOperators = queryOperators[engineSelector.value];

            // Initialize appState.queryBuilderFields if not present or engine changed
            if (!appState.queryBuilderFields || appState.queryBuilderEngine !== engineSelector.value) {
                appState.queryBuilderFields = [{ id: 'field-0', operator: 'keyword', value: '' }];
                appState.queryBuilderEngine = engineSelector.value;
            }

            appState.queryBuilderFields.forEach((field, index) => {
                const row = document.createElement('div');
                row.className = 'query-field-row';
                row.dataset.fieldId = field.id;

                const operatorSelect = document.createElement('select');
                operatorSelect.className = 'operator-select';
                currentEngineOperators.forEach(op => {
                    const option = document.createElement('option');
                    option.value = op.id;
                    option.textContent = op.label;
                    operatorSelect.appendChild(option);
                });
                operatorSelect.value = field.operator;
                operatorSelect.addEventListener('change', (e) => {
                    const newOperatorId = e.target.value;
                    const newOperatorDef = currentEngineOperators.find(op => op.id === newOperatorId);
                    field.operator = newOperatorId;
                    field.prefix = newOperatorDef.prefix || '';
                    field.placeholder = newOperatorDef.placeholder || '';
                    // Re-render to update input placeholder/type if needed
                    updateLivePreview();
                    localStorage.setItem('queryBuilderFields', JSON.stringify(appState.queryBuilderFields));
                });
                row.appendChild(operatorSelect);

                const valueInput = document.createElement('input');
                valueInput.type = field.type || 'text';
                valueInput.placeholder = currentEngineOperators.find(op => op.id === field.operator)?.placeholder || '';
                valueInput.value = field.value;
                valueInput.addEventListener('input', (e) => {
                    field.value = e.target.value;
                    updateLivePreview();
                    localStorage.setItem('queryBuilderFields', JSON.stringify(appState.queryBuilderFields));
                });
                row.appendChild(valueInput);

                // Allow removing all but the first if it's a keyword AND there's more than one field
                // Or if it's not a keyword and there's more than one field
                if (appState.queryBuilderFields.length > 1 || field.operator !== 'keyword') {
                    const removeButton = document.createElement('button');
                    removeButton.className = 'remove-field-button';
                    removeButton.innerHTML = '&times;';
                    removeButton.title = 'Remove field';
                    removeButton.addEventListener('click', () => {
                        appState.queryBuilderFields = appState.queryBuilderFields.filter(f => f.id !== field.id);
                        if (appState.queryBuilderFields.length === 0) {
                             // If all removed, add a default keyword field
                             const defaultOp = currentEngineOperators.find(op => op.id === 'keyword') || currentEngineOperators[0];
                             appState.queryBuilderFields.push({ id: `field-${Date.now()}`, operator: defaultOp.id, value: '', prefix: defaultOp.prefix || '', placeholder: defaultOp.placeholder || '' });
                        }
                        renderQueryBuilderFields();
                        updateLivePreview();
                        localStorage.setItem('queryBuilderFields', JSON.stringify(appState.queryBuilderFields));
                    });
                    row.appendChild(removeButton);
                }
                structuredQueryFieldsContainer.appendChild(row);
            });

            updateLivePreview(); // Always update after rendering fields
        }

        /**
         * Adds a new operator field to the query builder.
         */
        function addOperatorField() {
            const newId = `field-${Date.now()}`;
            const currentEngineOperators = queryOperators[engineSelector.value];
            // Default to 'keyword' or the first available operator
            const defaultOperator = currentEngineOperators.find(op => op.id === 'keyword') || currentEngineOperators[0];

            if (defaultOperator) {
                appState.queryBuilderFields.push({
                    id: newId,
                    operator: defaultOperator.id,
                    value: '',
                    prefix: defaultOperator.prefix || '',
                    placeholder: defaultOperator.placeholder || ''
                });
                renderQueryBuilderFields();
                // Optionally focus on the new input
                const newInput = structuredQueryFieldsContainer.lastChild.querySelector('input');
                if (newInput) newInput.focus();
                localStorage.setItem('queryBuilderFields', JSON.stringify(appState.queryBuilderFields));
            } else {
                showToast('No operators available for this engine.', 'error');
            }
        }


        /**
         * Updates the live query preview in the Query Builder based on current mode.
         */
        function updateLivePreview() {
            let finalQuery = '';
            if (appState.queryBuilderMode === 'structured') {
                const queryParts = [];
                appState.queryBuilderFields.forEach(field => {
                    if (field.value.trim() !== '') {
                        let formattedValue = field.value.trim();
                        // Special handling for operators like OR, AND, exclude which don't take a value
                        // or if the user includes spaces in the value
                        if (field.operator === 'or' || field.operator === 'and') {
                            if (!formattedValue.startsWith('"') && !formattedValue.endsWith('"') && formattedValue.includes(' ')) {
                                formattedValue = `"${formattedValue}"`;
                            }
                            queryParts.push(`${field.prefix || ''}${formattedValue}`);
                        } else if (field.operator === 'exclude') {
                            if (!formattedValue.startsWith('"') && !formattedValue.endsWith('"') && formattedValue.includes(' ')) {
                                formattedValue = `"${formattedValue}"`;
                            }
                            queryParts.push(`${field.prefix || ''}${formattedValue}`);
                        } else if (field.operator === 'keyword' || field.operator === 'bang') {
                            if (!formattedValue.startsWith('"') && !formattedValue.endsWith('"') && formattedValue.includes(' ')) {
                                formattedValue = `"${formattedValue}"`;
                            }
                            queryParts.push(formattedValue);
                        } else {
                            if (!formattedValue.startsWith('"') && !formattedValue.endsWith('"') && formattedValue.includes(' ')) {
                                formattedValue = `"${formattedValue}"`;
                            }
                            queryParts.push(`${field.prefix || ''}${formattedValue}`);
                        }
                    }
                });
                finalQuery = queryParts.join(' ').trim();
            } else { // Manual mode
                finalQuery = manualQueryInput.value.trim();
            }

            liveQueryPreview.textContent = finalQuery || 'Your constructed search query will appear here.';
            runQueryLinter(finalQuery, engineSelector.value, appState.queryBuilderFields);
        }

        /**
         * Toggles the query builder between structured input and manual textarea.
         */
        function toggleQueryBuilderMode() {
            const currentQuery = liveQueryPreview.textContent; // Get the current query from preview
            const currentEngine = engineSelector.value;

            if (appState.queryBuilderMode === 'structured') {
                // Switch to manual mode
                manualQueryInput.value = currentQuery === 'Your constructed search query will appear here.' ? '' : currentQuery;
                structuredQueryFieldsContainer.style.display = 'none';
                addOperatorButton.style.display = 'none';
                manualQueryInput.style.display = 'block';
                manualModeBtn.classList.add('active');
                structuredModeBtn.classList.remove('active');
                manualQueryInput.focus();
                appState.queryBuilderMode = 'manual';
            } else {
                // Switch to structured mode
                appState.queryBuilderFields = parseQueryStringToFields(currentQuery, currentEngine);
                renderQueryBuilderFields(); // This will also call updateLivePreview
                structuredQueryFieldsContainer.style.display = 'flex'; // Use flex for column layout
                addOperatorButton.style.display = 'inline-flex';
                manualQueryInput.style.display = 'none';
                structuredModeBtn.classList.add('active');
                manualModeBtn.classList.remove('active');
                appState.queryBuilderMode = 'structured';
            }
            localStorage.setItem('queryBuilderMode', appState.queryBuilderMode);
        }


        /**
         * Mock conversion rules for the Query Converter.
         */
        const conversionRules = {
            googleToShodan: (query) => {
                let converted = query.replace(/site:(".*?"|\S+)/g, 'hostname:$1');
                converted = converted.replace(/intitle:(".*?"|\S+)/g, 'http.title:$1');
                converted = converted.replace(/inurl:(".*?"|\S+)/g, 'http.url:$1');
                converted = converted.replace(/filetype:(\w+)/g, ''); // Remove filetype
                let warnings = [];
                if (query.includes('filetype:')) warnings.push("The 'filetype:' operator is not directly supported by Shodan. It has been removed.");
                return { query: converted.trim(), warnings: warnings };
            },
            googleToCensys: (query) => {
                let converted = query.replace(/site:(".*?"|\S+)/g, 'services.web.host:$1');
                converted = converted.replace(/intitle:(".*?"|\S+)/g, 'title:$1');
                converted = converted.replace(/inurl:(".*?"|\S+)/g, 'services.web.page.url:$1');
                converted = converted.replace(/filetype:(\w+)/g, ''); // Remove filetype
                let warnings = [];
                if (query.includes('filetype:')) warnings.push("The 'filetype:' operator is not directly supported by Censys. It has been removed.");
                return { query: converted.trim(), warnings: warnings };
            },
            shodanToGoogle: (query) => {
                let converted = query.replace(/hostname:(".*?"|\S+)/g, 'site:$1');
                converted = converted.replace(/http\.title:(".*?"|\S+)/g, 'intitle:$1');
                converted = converted.replace(/http\.url:(".*?"|\S+)/g, 'inurl:$1');
                let warnings = [];
                if (query.includes('port:')) warnings.push("The 'port:' operator is not supported by Google. Consider searching for common port banners instead.");
                if (query.includes('product:')) warnings.push("The 'product:' operator is not supported by Google. Try generic keywords instead.");
                return { query: converted.trim(), warnings: warnings };
            },
            censysToGoogle: (query) => {
                let converted = query.replace(/services\.web\.host:(".*?"|\S+)/g, 'site:$1');
                converted = converted.replace(/title:(".*?"|\S+)/g, 'intitle:$1');
                converted = converted.replace(/services\.web\.page\.url:(".*?"|\S+)/g, 'inurl:$1');
                let warnings = [];
                if (query.includes('protocols:')) warnings.push("Censys 'protocols:' operator is not supported by Google. Try searching for specific protocol names.");
                if (query.includes('software.product:')) warnings.push("Censys 'software.product:' is not supported by Google. Try generic keywords instead.");
                return { query: converted.trim(), warnings: warnings };
            },
            defaultConversion: (query) => {
                return { query: query, warnings: ["Direct conversion between these engines is limited. Manual adjustments may be required."] };
            }
        };

        const engineIconMap = {
            google: 'https://img.icons8.com/color/48/000000/google-logo.png',
            shodan: 'https://img.icons8.com/external-tal-revivo-shadow-tal-revivo/48/000000/external-Shodan-is-a-search-engine-that-lets-you-find-specific-types-of-computers-connected-to-the-internet-logo-shadow-tal-revivo.png',
            censys: 'https://img.icons8.com/external-tal-revivo-regular-tal-revivo/48/000000/external-Censys-is-a-global-search-engine-for-Internet-devices-that-collects-data-on-hosts-and-websites-logo-regular-tal-revivo.png',
            yandex: 'https://img.icons8.com/color/48/000000/yandex--v1.png',
            duckduckgo: 'https://img.icons8.com/color/48/000000/duckduckgo.png'
        };

        /**
         * Renders the template cards/list in the Template Library based on filters and view mode.
         */
        function renderTemplateLibrary() {
            templateCardsContainer.innerHTML = '';
            templateListTableBody.innerHTML = '';

            const searchTerm = templateSearchInput.value.toLowerCase();
            const selectedCategory = filterCategory.value;
            const selectedEngine = filterEngine.value;
            const selectedRisk = filterRisk.value;
            const showFavoritesOnly = appState.filterFavorites;

            const filteredTemplates = mockTemplateData.filter(template => {
                const matchesSearch = template.title.toLowerCase().includes(searchTerm) ||
                                            template.description.toLowerCase().includes(searchTerm) ||
                                            template.tags.some(tag => tag.toLowerCase().includes(searchTerm)) ||
                                            template.queryString.toLowerCase().includes(searchTerm); // Search in query string too
                const matchesCategory = selectedCategory === '' || template.category === selectedCategory;
                const matchesEngine = selectedEngine === '' || template.engineSupport.includes(selectedEngine);
                const matchesRisk = selectedRisk === '' || template.riskLevel.toLowerCase() === selectedRisk;
                const isFavorited = appState.savedQueries.some(q => q.id === template.id && q.favorited);

                return matchesSearch && matchesCategory && matchesEngine && matchesRisk && (!showFavoritesOnly || isFavorited);
            });

            // Update favorite button state
            if (showFavoritesOnly) {
                filterFavoritesButton.classList.add('active');
            } else {
                filterFavoritesButton.classList.remove('active');
            }

            if (filteredTemplates.length === 0) {
                const message = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">No templates found matching your criteria. Try adjusting your filters.</p>';
                templateCardsContainer.innerHTML = message;
                templateListTableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">${message}</td></tr>`;
            }

            if (appState.templateView === 'card-view') {
                templateCardsContainer.style.display = 'grid';
                templateListContainer.style.display = 'none';
                templateCardViewBtn.classList.add('active');
                templateListViewBtn.classList.remove('active');

                filteredTemplates.forEach(template => {
                    const isFavorited = appState.savedQueries.some(q => q.id === template.id && q.favorited);
                    const card = document.createElement('div');
                    card.className = 'template-card';
                    card.dataset.templateId = template.id; // For modal click handler
                    card.innerHTML = `
                        <h3>${template.title}</h3>
                        <p class="template-description">${template.description}</p>
                        <pre class="template-code-preview">${template.queryString.length > 70 ? template.queryString.substring(0, 70) + '...' : template.queryString}</pre>
                        <div class="template-meta">
                            <span class="compatibility-icons">
                                ${template.engineSupport.map(engine =>
                                    engineIconMap[engine] ? `<img src="${engineIconMap[engine]}" alt="${engine} Compatible" title="${engine}">` : ''
                                ).join('')}
                            </span>
                            <span class="risk-level risk-${template.riskLevel.toLowerCase()}">${template.riskLevel} Risk</span>
                        </div>
                        <div class="template-actions">
                            <button class="favorite-button" data-template-id="${template.id}" aria-label="Favorite Template">
                                <span class="icon icon-favorite ${isFavorited ? 'active' : ''}"></span>
                            </button>
                            <button class="action-button use-now-button" data-template-id="${template.id}">Use Now</button>
                        </div>
                    `;
                    templateCardsContainer.appendChild(card);
                });

                // Add event listeners for card view
                templateCardsContainer.querySelectorAll('.template-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        // Only open modal if not clicking on buttons inside the card
                        if (!e.target.closest('button')) {
                            const templateId = card.dataset.templateId;
                            openTemplateDetailModal(templateId);
                        }
                    });
                });
                templateCardsContainer.querySelectorAll('.use-now-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent card click event
                        const templateId = e.currentTarget.dataset.templateId;
                        const template = mockTemplateData.find(t => t.id === templateId);
                        if (template) {
                            // When using a template, load it into the advanced builder format
                            loadTemplateIntoQueryBuilder(template);
                            switchModule('query-builder');
                            showToast('Template loaded into Query Builder!', 'success');
                        }
                    });
                });
                templateCardsContainer.querySelectorAll('.favorite-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent card click event
                        toggleTemplateFavorite(e.currentTarget.dataset.templateId);
                    });
                });

            } else { // List View
                templateCardsContainer.style.display = 'none';
                templateListContainer.style.display = 'block';
                templateListViewBtn.classList.add('active');
                templateCardViewBtn.classList.remove('active');

                filteredTemplates.forEach(template => {
                    const isFavorited = appState.savedQueries.some(q => q.id === template.id && q.favorited);
                    const row = document.createElement('tr');
                    row.dataset.templateId = template.id; // For modal click handler
                    row.innerHTML = `
                        <td>${template.title}</td>
                        <td class="template-description-cell" title="${template.description}">${template.description}</td>
                        <td><code class="template-list-code-preview" title="${template.queryString}">${template.queryString.length > 50 ? template.queryString.substring(0, 50) + '...' : template.queryString}</code></td>
                        <td>${template.engineSupport.map(engine =>
                            engineIconMap[engine] ? `<img src="${engineIconMap[engine]}" alt="${engine} Compatible" title="${engine}" style="height:18px; margin-right:3px;">` : ''
                        ).join('')}</td>
                        <td><span class="risk-level risk-${template.riskLevel.toLowerCase()}">${template.riskLevel}</span></td>
                        <td>
                            <div class="template-list-actions">
                                <button class="favorite-button" data-template-id="${template.id}" aria-label="Favorite Template">
                                    <span class="icon icon-favorite ${isFavorited ? 'active' : ''}"></span>
                                </button>
                                <button class="action-button use-now-button" data-template-id="${template.id}">Use</button>
                            </div>
                        </td>
                    `;
                    templateListTableBody.appendChild(row);
                });

                // Add event listeners for list view
                templateListTableBody.querySelectorAll('tr').forEach(row => {
                    row.addEventListener('click', (e) => {
                        // Only open modal if not clicking on buttons inside the row
                        if (!e.target.closest('button')) {
                            const templateId = row.dataset.templateId;
                            openTemplateDetailModal(templateId);
                        }
                    });
                });
                templateListTableBody.querySelectorAll('.use-now-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent row click event
                        const templateId = e.currentTarget.dataset.templateId;
                        const template = mockTemplateData.find(t => t.id === templateId);
                        if (template) {
                            loadTemplateIntoQueryBuilder(template);
                            switchModule('query-builder');
                            showToast('Template loaded into Query Builder!', 'success');
                        }
                    });
                });
                templateListTableBody.querySelectorAll('.favorite-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent row click event
                        toggleTemplateFavorite(e.currentTarget.dataset.templateId);
                    });
                });
            }
        }

        /**
         * Toggles the favorite status of a template.
         * @param {string} templateId - The ID of the template.
         */
        function toggleTemplateFavorite(templateId) {
            let existingSavedQuery = appState.savedQueries.find(q => q.id === templateId);
            const templateData = mockTemplateData.find(t => t.id === templateId);

            if (!templateData) return;

            if (existingSavedQuery) {
                existingSavedQuery.favorited = !existingSavedQuery.favorited;
                // If it was only saved for favorite, and now unfavorited, remove it completely
                if (!existingSavedQuery.favorited && existingSavedQuery.id.startsWith('tpl-')) {
                     appState.savedQueries = appState.savedQueries.filter(q => q.id !== templateId);
                     showToast('Template removed from favorites and saved queries.', 'info');
                } else {
                    showToast(existingSavedQuery.favorited ? 'Added to favorites!' : 'Removed from favorites.', 'success');
                }
            } else {
                existingSavedQuery = {
                    id: templateData.id,
                    name: `[T] ${templateData.title}`,
                    query: templateData.queryString,
                    engine: templateData.engineSupport[0] || 'google',
                    favorited: true // Ensure favorited is true for new entry
                };
                appState.savedQueries.push(existingSavedQuery);
                showToast('Added to favorites!', 'success');
            }
            localStorage.setItem('savedQueries', JSON.stringify(appState.savedQueries));
            renderTemplateLibrary(); // Re-render to update star icon
            renderSavedQueries(); // Re-render saved queries too
        }


        /**
         * Parses a raw query string into structured fields for the Query Builder.
         * This is a simplified parser and might not handle all edge cases perfectly.
         * @param {string} queryString - The raw query string.
         * @param {string} engine - The target engine for parsing.
         * @returns {Array<Object>} An array of structured query field objects.
         */
        function parseQueryStringToFields(queryString, engine) {
            const fields = [];
            const operators = queryOperators[engine];
            let remainingQuery = queryString.trim();
            let fieldIdCounter = 0;

            if (!remainingQuery) {
                // If query is empty, return a single empty keyword field
                const keywordOpDef = operators.find(o => o.id === 'keyword');
                return [{ id: `field-${fieldIdCounter++}`, operator: 'keyword', value: '', prefix: keywordOpDef.prefix || '', placeholder: keywordOpDef.placeholder || '' }];
            }

            // Regex to match quoted phrases or unquoted words/terms.
            // This is a more robust way to handle tokenization than simple split(' ')
            const tokens = remainingQuery.match(/"[^"]+"|'[^']+'|\S+/g) || [];

            tokens.forEach(token => {
                let matched = false;
                // Try to match operators with their prefixes
                for (const opDef of operators) {
                    if (opDef.prefix && token.startsWith(opDef.prefix)) {
                        let value = token.substring(opDef.prefix.length);
                        // Remove quotes if they exist around the value part (e.g., inurl:"foo bar")
                        if (value.startsWith('"') && value.endsWith('"')) {
                            value = value.substring(1, value.length - 1);
                        }
                        fields.push({
                            id: `field-${fieldIdCounter++}`,
                            operator: opDef.id,
                            value: value,
                            prefix: opDef.prefix,
                            placeholder: opDef.placeholder
                        });
                        matched = true;
                        break;
                    }
                }

                if (!matched) {
                    // If no operator prefix matched, treat it as a keyword
                    let value = token;
                    // Remove quotes if they exist around the entire token (e.g., "foo bar")
                    if (value.startsWith('"') && value.endsWith('"')) {
                        value = value.substring(1, value.length - 1);
                    }
                    const keywordOpDef = operators.find(o => o.id === 'keyword');
                    if (keywordOpDef) {
                        fields.push({
                            id: `field-${fieldIdCounter++}`,
                            operator: 'keyword',
                            value: value,
                            prefix: keywordOpDef.prefix || '',
                            placeholder: keywordOpDef.placeholder || ''
                        });
                    }
                }
            });

            // If still no fields (e.g., an empty string initially), add a default keyword field
            if (fields.length === 0) {
                const keywordOpDef = operators.find(o => o.id === 'keyword');
                fields.push({ id: `field-0`, operator: 'keyword', value: '', prefix: keywordOpDef.prefix || '', placeholder: keywordOpDef.placeholder || '' });
            }

            return fields;
        }

        /**
         * Loads a template's query string into the advanced query builder.
         * @param {Object} template - The template object.
         */
        function loadTemplateIntoQueryBuilder(template) {
            engineSelector.value = template.engineSupport[0] || 'google'; // Set engine first
            appState.queryBuilderEngine = engineSelector.value;
            appState.queryBuilderMode = 'structured'; // Ensure structured mode
            localStorage.setItem('queryBuilderMode', 'structured');
            structuredModeBtn.classList.add('active');
            manualModeBtn.classList.remove('active');

            appState.queryBuilderFields = parseQueryStringToFields(template.queryString, appState.queryBuilderEngine);
            renderQueryBuilderFields();

            structuredQueryFieldsContainer.style.display = 'flex';
            addOperatorButton.style.display = 'inline-flex';
            manualQueryInput.style.display = 'none';
        }


        /**
         * Renders the list of saved queries.
         */
        function renderSavedQueries() {
            savedQueriesList.innerHTML = '';
            if (appState.savedQueries.length === 0) {
                noSavedQueriesMessage.style.display = 'block';
                return;
            } else {
                noSavedQueriesMessage.style.display = 'none';
            }

            // Sort favorites to top, then by name
            const sortedSavedQueries = [...appState.savedQueries].sort((a, b) => {
                if (a.favorited && !b.favorited) return -1;
                if (!a.favorited && b.favorited) return 1;
                return a.name.localeCompare(b.name);
            });


            sortedSavedQueries.forEach(sq => {
                const item = document.createElement('div');
                item.className = 'saved-query-item';
                item.dataset.id = sq.id;
                item.innerHTML = `
                    <span class="query-title">${sq.name}</span>
                    <span class="query-engine">(${sq.engine.charAt(0).toUpperCase() + sq.engine.slice(1)})</span>
                    <span class="query-text" title="${sq.query}">${sq.query}</span>
                    <div class="query-actions">
                        <button class="action-button secondary edit-query">Edit</button>
                        <button class="action-button secondary rename-query">Rename</button>
                        <button class="action-button secondary delete-query" aria-label="Delete Query"><span class="icon icon-delete"></span></button>
                        <button class="favorite-toggle" aria-label="Toggle Favorite">
                            <span class="icon icon-favorite ${sq.favorited ? 'active' : ''}"></span>
                        </button>
                        <button class="action-button run-query">Run</button>
                    </div>
                `;
                savedQueriesList.appendChild(item);
            });

            savedQueriesList.querySelectorAll('.edit-query').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.closest('.saved-query-item').dataset.id;
                    const queryObj = appState.savedQueries.find(q => q.id == id);
                    if (queryObj) {
                        loadTemplateIntoQueryBuilder(queryObj); // Re-use template loading for consistency
                        switchModule('query-builder');
                        showToast('Query loaded into Query Builder!', 'success');
                    }
                });
            });
            savedQueriesList.querySelectorAll('.rename-query').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.currentTarget.closest('.saved-query-item').dataset.id;
                    const query = appState.savedQueries.find(q => q.id == id);
                    if (query) {
                        const newName = await showSaveQueryModal('Rename Query', query.name);
                        if (newName !== null && newName.trim() !== '') {
                            query.name = newName.trim();
                            localStorage.setItem('savedQueries', JSON.stringify(appState.savedQueries));
                            renderSavedQueries();
                            showToast('Query renamed!', 'success');
                        } else if (newName !== null) { // newName is empty string, but not cancelled
                            showToast('Query name cannot be empty. Rename cancelled.', 'error');
                        }
                    }
                });
            });
            savedQueriesList.querySelectorAll('.delete-query').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.currentTarget.closest('.saved-query-item').dataset.id;
                    const query = appState.savedQueries.find(q => q.id == id);
                    if (!query) return;

                    const confirmed = await showConfirmModal(`Are you sure you want to delete the query "${query.name}"?`);
                    if (confirmed) {
                        appState.savedQueries = appState.savedQueries.filter(q => q.id != id);
                        localStorage.setItem('savedQueries', JSON.stringify(appState.savedQueries));
                        renderSavedQueries();
                        renderTemplateLibrary(); // Update template stars
                        showToast('Query deleted successfully.', 'success');
                    } else {
                        showToast('Query deletion cancelled.', 'info');
                    }
                });
            });
            savedQueriesList.querySelectorAll('.favorite-toggle').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.closest('.saved-query-item').dataset.id;
                    const query = appState.savedQueries.find(q => q.id == id);
                    if (query) {
                        query.favorited = !query.favorited;
                        localStorage.setItem('savedQueries', JSON.stringify(appState.savedQueries));
                        renderSavedQueries();
                        renderTemplateLibrary();
                        showToast(query.favorited ? 'Marked as favorite!' : 'Removed from favorites.', 'success');
                    }
                });
            });
            savedQueriesList.querySelectorAll('.run-query').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.closest('.saved-query-item').dataset.id;
                    const query = appState.savedQueries.find(q => q.id == id);
                    if (query) {
                        const fullUrl = generateQueryUrl(query.query, query.engine);
                        window.open(fullUrl, '_blank');
                        showToast('Query executed from saved list!', 'success');
                        logUsage(query.engine, query.query, true);
                    }
                });
            });
        }

        /**
         * Shows a custom modal for saving/renaming a query.
         * @param {string} title - The title for the modal.
         * @param {string} initialValue - Initial value for the input field.
         * @returns {Promise<string|null>} Resolves with the entered name, or null if cancelled.
         */
        function showSaveQueryModal(title, initialValue = '') {
            saveQueryModal.classList.add('show');
            saveQueryModal.querySelector('h3').textContent = title;
            saveQueryNameInput.value = initialValue;
            saveQueryNameInput.focus();

            return new Promise((resolve) => {
                const handleSave = () => {
                    saveQueryModal.classList.remove('show');
                    saveQueryConfirmBtn.removeEventListener('click', handleSave);
                    saveQueryCancelBtn.removeEventListener('click', handleCancel);
                    saveQueryModal.removeEventListener('click', handleOverlayClick);
                    saveQueryModal.querySelector('.modal-close').removeEventListener('click', handleCancel);
                    resolve(saveQueryNameInput.value);
                };
                const handleCancel = () => {
                    saveQueryModal.classList.remove('show');
                    saveQueryConfirmBtn.removeEventListener('click', handleSave);
                    saveQueryCancelBtn.removeEventListener('click', handleCancel);
                    saveQueryModal.removeEventListener('click', handleOverlayClick);
                    saveQueryModal.querySelector('.modal-close').removeEventListener('click', handleCancel);
                    resolve(null);
                };
                const handleOverlayClick = (e) => {
                    if (e.target === saveQueryModal) {
                        handleCancel();
                    }
                };

                saveQueryConfirmBtn.addEventListener('click', handleSave);
                saveQueryCancelBtn.addEventListener('click', handleCancel);
                saveQueryModal.querySelector('.modal-close').addEventListener('click', handleCancel);
                saveQueryModal.addEventListener('click', handleOverlayClick);

                // Allow Enter key to confirm
                saveQueryNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // Prevent default form submission
                        handleSave();
                    }
                }, { once: true });
            });
        }

        /**
         * Shows a custom confirmation modal.
         * @param {string} message - The message to display.
         * @returns {Promise<boolean>} Resolves true if confirmed, false if cancelled.
         */
        function showConfirmModal(message) {
            confirmDeleteModal.classList.add('show');
            confirmDeleteMessage.textContent = message;

            return new Promise((resolve) => {
                const handleConfirm = () => {
                    confirmDeleteModal.classList.remove('show');
                    confirmDeleteConfirmBtn.removeEventListener('click', handleConfirm);
                    confirmDeleteCancelBtn.removeEventListener('click', handleCancel);
                    confirmDeleteModal.removeEventListener('click', handleOverlayClick);
                    confirmDeleteModal.querySelector('.modal-close').removeEventListener('click', handleCancel);
                    resolve(true);
                };
                const handleCancel = () => {
                    confirmDeleteModal.classList.remove('show');
                    confirmDeleteConfirmBtn.removeEventListener('click', handleConfirm);
                    confirmDeleteCancelBtn.removeEventListener('click', handleCancel);
                    confirmDeleteModal.removeEventListener('click', handleOverlayClick);
                    confirmDeleteModal.querySelector('.modal-close').removeEventListener('click', handleCancel);
                    resolve(false);
                };
                const handleOverlayClick = (e) => {
                    if (e.target === confirmDeleteModal) {
                        handleCancel();
                    }
                };

                confirmDeleteConfirmBtn.addEventListener('click', handleConfirm);
                confirmDeleteCancelBtn.addEventListener('click', handleCancel);
                confirmDeleteModal.querySelector('.modal-close').addEventListener('click', handleCancel);
                confirmDeleteModal.addEventListener('click', handleOverlayClick);
            });
        }

        /**
         * Opens the template detail modal with the given template's information.
         * @param {string} templateId - The ID of the template to display.
         */
        function openTemplateDetailModal(templateId) {
            const template = mockTemplateData.find(t => t.id === templateId);
            if (!template) {
                showToast('Template not found!', 'error');
                return;
            }

            // Assign elements to the globally declared variables
            // Ensure these are correctly cached in DOMContentLoaded
            // and accessed here. The previous error was that templateModalTitle was null
            // when attempted to be read.
            templateModalTitle.textContent = template.title;
            templateModalDescription.textContent = template.description;
            templateModalQuery.value = template.queryString; // Set the command line query

            // Clear previous engine icons
            templateModalEngines.innerHTML = '';
            template.engineSupport.forEach(engine => {
                if (engineIconMap[engine]) {
                    const img = document.createElement('img');
                    img.src = engineIconMap[engine];
                    img.alt = `${engine} Compatible`;
                    img.title = engine;
                    img.style.height = '24px'; // Slightly larger in modal
                    img.style.marginRight = '8px';
                    templateModalEngines.appendChild(img);
                }
            });

            templateModalRisk.className = `risk-level risk-${template.riskLevel.toLowerCase()}`;
            templateModalRisk.textContent = `${template.riskLevel} Risk`;

            // Set data attributes for buttons to use
            templateModalCopyBtn.dataset.query = template.queryString;
            templateModalCustomizeBtn.dataset.query = template.queryString;
            templateModalCustomizeBtn.dataset.engine = template.engineSupport[0] || 'google';
            templateModalUseNowBtn.dataset.query = template.queryString;
            templateModalUseNowBtn.dataset.engine = template.engineSupport[0] || 'google';

            templateDetailModal.classList.add('show');
        }

        /**
         * Generates a random dork based on current filters.
         */
        let currentGeneratedDork = null;

        function generateRandomDork() {
            const filterEng = generatorEngine.value;
            const filterCat = generatorCategory.value;

            let filteredDorks = mockTemplateData.filter(dork => {
                const engineMatch = filterEng === '' || dork.engineSupport.includes(filterEng);
                const categoryMatch = filterCat === '' || dork.category === filterCat;
                return engineMatch && categoryMatch;
            });

            if (filteredDorks.length === 0) {
                generatedDorkTitle.textContent = 'No dorks found matching your criteria!';
                generatedDorkDescription.textContent = 'Try adjusting your engine or category filters.';
                generatedDorkQuery.textContent = '_no_matching_dorks_';
                currentGeneratedDork = null;
                autoRunDorkButton.disabled = true;
                reviewDorkButton.disabled = true;
                addToSavedDorkButton.disabled = true;
                copyGeneratedDorkButton.disabled = true;
                return;
            }

            const randomIndex = Math.floor(Math.random() * filteredDorks.length);
            currentGeneratedDork = filteredDorks[randomIndex];

            generatedDorkTitle.textContent = currentGeneratedDork.title;
            generatedDorkDescription.textContent = currentGeneratedDork.description;
            generatedDorkQuery.textContent = currentGeneratedDork.queryString;
            autoRunDorkButton.disabled = false;
            reviewDorkButton.disabled = false;
            addToSavedDorkButton.disabled = false;
            copyGeneratedDorkButton.disabled = false;
        }

        /**
         * Renders the Engine Compatibility Matrix table.
         */
        function renderEngineCompatibilityMatrix() {
            compatibilityTableBody.innerHTML = '';
            compatibilityData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><code>${row.operator}</code></td>
                    <td><span class="support-icon support-${row.google.includes('✔') ? 'yes' : (row.google.includes('✘') ? 'no' : 'partial')}">${row.google}</span></td>
                    <td><span class="support-icon support-${row.shodan.includes('✔') ? 'yes' : (row.shodan.includes('✘') ? 'no' : 'partial')}">${row.shodan}</span></td>
                    <td><span class="support-icon support-${row.censys.includes('✔') ? 'yes' : (row.censys.includes('✘') ? 'no' : 'partial')}">${row.censys}</span></td>
                    <td><span class="support-icon support-${row.yandex.includes('✔') ? 'yes' : (row.yandex.includes('✘') ? 'no' : 'partial')}">${row.yandex}</span></td>
                    <td><span class="support-icon support-${row.duckduckgo.includes('✔') ? 'yes' : (row.duckduckgo.includes('✘') ? 'no' : 'partial')}">${row.duckduckgo}</span></td>
                    <td>${row.notes}</td>
                `;
                compatibilityTableBody.appendChild(tr);
            });
        }

        /**
         * Logs a query usage event for analytics.
         * @param {string} engine - The engine used.
         * @param {string} query - The query string.
         * @param {boolean} success - Whether the execution was successful.
         */
        function logUsage(engine, query, success) {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const matchingTemplate = mockTemplateData.find(tpl => tpl.queryString === query);
            const category = matchingTemplate ? matchingTemplate.category : 'uncategorized'; // Default to 'uncategorized'

            appState.usageHistory.push({
                timestamp: now.getTime(),
                date: today,
                engine: engine,
                query: query,
                success: success,
                category: category
            });
            localStorage.setItem('usageHistory', JSON.stringify(appState.usageHistory));
            if (appState.activeModule === 'dashboard') renderDashboard();
            if (appState.activeModule === 'analytics') renderAnalyticsCharts();
        }

        /**
         * Helper to get formatted date string for charts.
         * @param {number} offsetDays - Number of days back from today.
         * @returns {string} Date in форматеYYYY-MM-DD.
         */
        function getFormattedDate(offsetDays) {
            const d = new Date();
            d.setDate(d.getDate() - offsetDays);
            return d.toISOString().split('T')[0];
        }

        /**
         * Renders the Dashboard summary and chart.
         */
        function renderDashboard() {
            if (activityChartInstance) activityChartInstance.destroy();

            document.getElementById('total-queries').textContent = appState.usageHistory.length;
            const enginesUsed = new Set(appState.usageHistory.map(item => item.engine));
            document.getElementById('engines-used').textContent = enginesUsed.size;

            const topTemplatesAgg = {};
            appState.usageHistory.forEach(usage => {
                const matchingTemplate = mockTemplateData.find(tpl => tpl.queryString === usage.query);
                if (matchingTemplate) {
                    topTemplatesAgg[matchingTemplate.title] = (topTemplatesAgg[matchingTemplate.title] || 0) + 1;
                }
            });
            const sortedTemplates = Object.entries(topTemplatesAgg).sort(([, a], [, b]) => b - a);
            document.getElementById('top-templates').textContent = sortedTemplates.length > 0 ? sortedTemplates[0][0] : 'N/A';
            document.getElementById('saved-items').textContent = appState.savedQueries.length;

            // New Dashboard Metrics
            const totalQueryLength = appState.usageHistory.reduce((sum, item) => sum + item.query.length, 0);
            const avgQueryLength = appState.usageHistory.length > 0 ? (totalQueryLength / appState.usageHistory.length).toFixed(1) : 0;
            avgQueryLengthDisplay.textContent = avgQueryLength;

            const dailyQueryCounts = {};
            appState.usageHistory.forEach(item => {
                dailyQueryCounts[item.date] = (dailyQueryCounts[item.date] || 0) + 1;
            });
            let mostActiveDay = 'N/A';
            let maxQueries = 0;
            for (const date in dailyQueryCounts) {
                if (dailyQueryCounts[date] > maxQueries) {
                    maxQueries = dailyQueryCounts[date];
                    mostActiveDay = date;
                }
            }
            mostActiveDayDisplay.textContent = mostActiveDay === 'N/A' ? 'N/A' : `${mostActiveDay} (${maxQueries} queries)`;


            const lastQuery = appState.usageHistory.length > 0 ? appState.usageHistory[appState.usageHistory.length - 1] : null;
            if (lastQuery) {
                const lastQueryDate = new Date(lastQuery.timestamp);
                lastQueryTimeDisplay.textContent = `${lastQueryDate.toLocaleDateString()} ${lastQueryDate.toLocaleTimeString()}`;
            } else {
                lastQueryTimeDisplay.textContent = 'N/A';
            }


            const last7DaysLabels = Array.from({ length: 7 }, (_, i) => getFormattedDate(6 - i));

            const dailyActivity = last7DaysLabels.map(date => {
                return appState.usageHistory.filter(item => item.date === date).length;
            });

            activityChartInstance = new Chart(activityChartCtx, {
                type: 'line',
                data: {
                    labels: last7DaysLabels,
                    datasets: [{
                        label: 'Queries Executed',
                        data: dailyActivity,
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-color'),
                        backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-color') + '33', // 20% opacity
                        tension: 0.3,
                        fill: true,
                        pointRadius: 5,
                        pointBackgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-color'),
                        pointBorderColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-hover'),
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0, color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') },
                            grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') }
                        },
                        x: {
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        /**
         * Renders the Analytics charts based on the selected date range.
         */
        function renderAnalyticsCharts() {
            if (topEnginesChartInstance) topEnginesChartInstance.destroy();
            if (topCategoriesChartInstance) topCategoriesChartInstance.destroy();
            if (successfulExecutionsChartInstance) successfulExecutionsChartInstance.destroy();

            const dateRangeValue = analyticsDateRangeSelect.value;
            let filteredUsage = [];
            const now = Date.now();

            if (dateRangeValue === 'all') {
                filteredUsage = appState.usageHistory;
            } else {
                const days = parseInt(dateRangeValue);
                const cutoffTime = now - (days * 24 * 60 * 60 * 1000);
                filteredUsage = appState.usageHistory.filter(item => item.timestamp >= cutoffTime);
            }

            // Get references to existing canvas elements, or create new ones if they were replaced by 'No data' messages
            let currentTopEnginesCanvas = document.getElementById('top-engines-chart');
            let currentTopCategoriesCanvas = document.getElementById('top-categories-chart');
            let currentSuccessfulExecutionsCanvas = document.getElementById('successful-executions-chart');

            // If a canvas was removed (e.g., due to 'No data' message), re-add it to its parent
            if (!currentTopEnginesCanvas || currentTopEnginesCanvas.tagName.toLowerCase() !== 'canvas') {
                const parent = document.querySelector('#analytics .chart-card:nth-child(1)');
                currentTopEnginesCanvas = document.createElement('canvas');
                currentTopEnginesCanvas.id = 'top-engines-chart';
                parent.innerHTML = '<h2>Top Used Engines</h2>'; // Clear previous content
                parent.appendChild(currentTopEnginesCanvas);
            }
            if (!currentTopCategoriesCanvas || currentTopCategoriesCanvas.tagName.toLowerCase() !== 'canvas') {
                const parent = document.querySelector('#analytics .chart-card:nth-child(2)');
                currentTopCategoriesCanvas = document.createElement('canvas');
                currentTopCategoriesCanvas.id = 'top-categories-chart';
                parent.innerHTML = '<h2>Top Dork Categories</h2>'; // Clear previous content
                parent.appendChild(currentTopCategoriesCanvas);
            }
            if (!currentSuccessfulExecutionsCanvas || currentSuccessfulExecutionsCanvas.tagName.toLowerCase() !== 'canvas') {
                const parent = document.querySelector('#analytics .chart-card:nth-child(3)');
                currentSuccessfulExecutionsCanvas = document.createElement('canvas');
                currentSuccessfulExecutionsCanvas.id = 'successful-executions-chart';
                parent.innerHTML = '<h2>Successful Executions Over Time</h2>'; // Clear previous content
                parent.appendChild(currentSuccessfulExecutionsCanvas);
            }

            topEnginesChartCtx = currentTopEnginesCanvas.getContext('2d');
            topCategoriesChartCtx = currentTopCategoriesCanvas.getContext('2d');
            successfulExecutionsChartCtx = currentSuccessfulExecutionsCanvas.getContext('2d');


            if (filteredUsage.length === 0) {
                 [topEnginesChartCtx, topCategoriesChartCtx, successfulExecutionsChartCtx].forEach(ctx => {
                    if (ctx && ctx.canvas) { // Check if context and canvas exist
                        const parent = ctx.canvas.parentElement;
                        if (parent) {
                            parent.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding-top: 50px;">No data for the selected period.</p>';
                        }
                    }
                 });
                 return; // Exit if no data
            }


            const engineCounts = {};
            filteredUsage.forEach(item => {
                engineCounts[item.engine] = (engineCounts[item.engine] || 0) + 1;
            });
            const engineLabels = Object.keys(engineCounts);
            const engineData = Object.values(engineCounts);
            topEnginesChartInstance = new Chart(topEnginesChartCtx, {
                type: 'pie',
                data: {
                    labels: engineLabels.map(e => e.charAt(0).toUpperCase() + e.slice(1)),
                    datasets: [{
                        data: engineData,
                        backgroundColor: ['#00F0FF', '#E0A0FF', '#FFC107', '#3498db', '#9b59b6', '#e74c3c'], // More vibrant OSINT colors
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') }
                        },
                        tooltip: { callbacks: { label: (context) => `${context.label}: ${context.raw}` } }
                    }
                }
            });

            const categoryCounts = {};
            filteredUsage.forEach(item => {
                let category = item.category || 'Uncategorized';
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
            });
            // Sort categories and take top N
            const sortedCategories = Object.entries(categoryCounts)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 10); // Show top 10 categories
            const categoryLabels = sortedCategories.map(([label]) => label);
            const categoryData = sortedCategories.map(([, count]) => count);

            topCategoriesChartInstance = new Chart(topCategoriesChartCtx, {
                type: 'bar',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        label: 'Queries by Category',
                        data: categoryData,
                        backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-color'),
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-hover'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0, color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') },
                            grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') }
                        },
                        x: {
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') },
                            grid: { display: false }
                        }
                    }
                }
            });

            const successByDate = {};
            // Aggregate by date for charting, even if range is 'all'
            filteredUsage.forEach(item => {
                if (!successByDate[item.date]) successByDate[item.date] = { total: 0, success: 0 };
                successByDate[item.date].total++;
                if (item.success) successByDate[item.date].success++;
            });

            const analyticsDates = Object.keys(successByDate).sort(); // Ensure chronological order
            const successfulExecutionsData = analyticsDates.map(date => successByDate[date].success);
            const totalExecutionsData = analyticsDates.map(date => successByDate[date].total);

            successfulExecutionsChartInstance = new Chart(successfulExecutionsChartCtx, {
                type: 'line',
                data: {
                    labels: analyticsDates,
                    datasets: [
                        {
                            label: 'Successful Executions',
                            data: successfulExecutionsData,
                            borderColor: '#28a745', // Green
                            backgroundColor: '#28a74533', // Green with opacity
                            tension: 0.3,
                            fill: true,
                            pointRadius: 4
                        },
                        {
                            label: 'Total Executions',
                            data: totalExecutionsData,
                            borderColor: '#ffc107', // Amber
                            backgroundColor: '#ffc10733', // Amber with opacity
                            tension: 0.3,
                            fill: true,
                            pointRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') } } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0, color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') },
                            grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') }
                        },
                        x: {
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        /**
         * Loads and displays saved settings in the Settings module.
         */
        function loadSettings() {
            shodanApiKeyInput.value = appState.apiKeys.shodan || '';
            censysApiKeyInput.value = appState.apiKeys.censys || '';
            defaultEngineSelect.value = appState.defaultEngine;
        }


        /**
         * Switches the active content module in the application.
         * Updates UI elements and triggers module-specific rendering.
         * @param {string} moduleName - The ID of the module section to activate.
         */
        function switchModule(moduleName) {
            const currentActiveModule = document.querySelector('.module-content.active');
            if (currentActiveModule) {
                currentActiveModule.classList.remove('active');
            }
            const currentActiveNavLink = document.querySelector('.nav-item.active');
            if (currentActiveNavLink) {
                currentActiveNavLink.classList.remove('active');
            }

            const newActiveModule = document.getElementById(moduleName);
            if (newActiveModule) {
                newActiveModule.classList.add('active');
            }
            const newActiveNavLink = document.querySelector(`.nav-item[data-module="${moduleName}"]`);
            if (newActiveNavLink) {
                newActiveNavLink.classList.add('active');
            }

            appState.activeModule = moduleName;
            localStorage.setItem('activeModule', moduleName);

            window.history.pushState(null, '', `#${moduleName}`);

            // Perform module-specific rendering/initialization
            switch (moduleName) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'query-builder':
                    // Restore correct builder mode display
                    if (appState.queryBuilderMode === 'structured') {
                        structuredQueryFieldsContainer.style.display = 'flex';
                        addOperatorButton.style.display = 'inline-flex';
                        manualQueryInput.style.display = 'none';
                        structuredModeBtn.classList.add('active');
                        manualModeBtn.classList.remove('active');
                        renderQueryBuilderFields(); // Re-render fields based on stored state
                    } else {
                        structuredQueryFieldsContainer.style.display = 'none';
                        addOperatorButton.style.display = 'none';
                        manualQueryInput.style.display = 'block';
                        structuredModeBtn.classList.remove('active');
                        manualModeBtn.classList.add('active');
                        updateLivePreview(); // Ensure manual input updates preview
                    }
                    break;
                case 'template-library':
                    renderTemplateLibrary();
                    break;
                case 'saved-queries':
                    renderSavedQueries();
                    break;
                case 'analytics':
                    renderAnalyticsCharts();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                case 'engine-compatibility':
                    renderEngineCompatibilityMatrix();
                    break;
                case 'random-query-lab':
                    // Regenerate random dork when entering module
                    generateRandomDork();
                    break;
                case 'wayback-machine':
                    // Clear previous results when entering module
                    waybackUrlInput.value = '';
                    waybackResultContainer.style.display = 'none';
                    waybackFeedback.style.display = 'none';
                    break;
            }
        }

        // --- DOMContentLoaded Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- Cache DOM elements after DOMContentLoaded ---
            structuredQueryFieldsContainer = document.getElementById('structured-query-fields');
            addOperatorButton = document.getElementById('add-operator-button');
            manualQueryInput = document.getElementById('manual-query-input');
            liveQueryPreview = document.getElementById('live-query-preview');
            engineSelector = document.getElementById('engine-selector');
            linterFeedback = document.getElementById('query-linter-feedback');
            copyLiveQueryButton = document.getElementById('copy-live-query-button');

            structuredModeBtn = document.getElementById('structured-mode-btn');
            manualModeBtn = document.getElementById('manual-mode-btn');

            templateCardsContainer = document.getElementById('template-cards-container');
            templateListContainer = document.getElementById('template-list-container');
            templateListTableBody = templateListContainer.querySelector('tbody');
            templateSearchInput = document.getElementById('template-search');
            filterCategory = document.getElementById('filter-category');
            filterEngine = document.getElementById('filter-engine');
            filterRisk = document.getElementById('filter-risk');
            filterFavoritesButton = document.getElementById('filter-favorites-button');
            templateCardViewBtn = document.getElementById('card-view-btn');
            templateListViewBtn = document.getElementById('list-view-btn');

            savedQueriesList = document.getElementById('saved-queries-list');
            noSavedQueriesMessage = document.getElementById('no-saved-queries-message');

            sourceQueryEditor = document.getElementById('source-query-editor');
            targetQueryOutput = document.getElementById('target-query-output');
            convertButton = document.getElementById('convert-button');
            converterSourceEngine = document.getElementById('source-engine');
            converterTargetEngine = document.getElementById('target-engine');
            conversionFeedback = document.getElementById('conversion-feedback');

            generateDorkButton = document.getElementById('generate-dork');
            generatorEngine = document.getElementById('generator-engine');
            generatorCategory = document.getElementById('generator-category');
            generatedDorkTitle = document.getElementById('generated-dork-title');
            generatedDorkDescription = document.getElementById('generated-dork-description');
            generatedDorkQuery = document.getElementById('generated-dork-query');
            copyGeneratedDorkButton = document.getElementById('copy-generated-dork');
            autoRunDorkButton = document.getElementById('auto-run-dork');
            reviewDorkButton = document.getElementById('review-dork');
            addToSavedDorkButton = document.getElementById('add-to-saved-dork');

            waybackUrlInput = document.getElementById('wayback-url');
            lookupWaybackButton = document.getElementById('lookup-wayback');
            waybackResultContainer = document.getElementById('wayback-result-container');
            waybackResultLink = document.querySelector('#wayback-result-link a');
            waybackDisplayUrl = document.getElementById('wayback-display-url');
            copyWaybackLinkButton = document.getElementById('copy-wayback-link-button');
            waybackFeedback = document.getElementById('wayback-feedback');


            compatibilityTableBody = document.querySelector('#compatibility-table tbody');

            activityChartCtx = document.getElementById('activity-chart').getContext('2d');
            topEnginesChartCtx = document.getElementById('top-engines-chart').getContext('2d');
            topCategoriesChartCtx = document.getElementById('top-categories-chart').getContext('2d');
            successfulExecutionsChartCtx = document.getElementById('successful-executions-chart').getContext('2d');
            analyticsDateRangeSelect = document.getElementById('analytics-date-range');

            // Dashboard elements
            avgQueryLengthDisplay = document.getElementById('avg-query-length');
            mostActiveDayDisplay = document.getElementById('most-active-day');
            lastQueryTimeDisplay = document.getElementById('last-query-time');


            shodanApiKeyInput = document.getElementById('shodan-api-key');
            censysApiKeyInput = document.getElementById('censys-api-key');
            defaultEngineSelect = document.getElementById('default-engine');

            // Modal elements
            saveQueryModal = document.getElementById('saveQueryModal');
            saveQueryNameInput = document.getElementById('save-query-name');
            saveQueryConfirmBtn = saveQueryModal.querySelector('.modal-save-confirm-btn');
            saveQueryCancelBtn = saveQueryModal.querySelector('.modal-cancel-btn');

            confirmDeleteModal = document.getElementById('confirmDeleteModal');
            confirmDeleteMessage = document.getElementById('confirm-delete-message');
            confirmDeleteConfirmBtn = confirmDeleteModal.querySelector('.modal-delete-confirm-btn');
            confirmDeleteCancelBtn = confirmDeleteModal.querySelector('.modal-cancel-btn');

            templateDetailModal = document.getElementById('templateDetailModal'); // Assign the main modal element
            templateModalTitle = document.getElementById('template-modal-title');
            templateModalDescription = document.getElementById('template-modal-description');
            templateModalEngines = document.getElementById('template-modal-engines');
            templateModalRisk = document.getElementById('template-modal-risk');
            templateModalQuery = document.getElementById('template-modal-query');
            templateModalCopyBtn = document.getElementById('template-modal-copy-btn');
            templateModalCustomizeBtn = document.getElementById('template-modal-customize-btn');
            templateModalUseNowBtn = document.getElementById('template-modal-use-now-btn');


            // --- Apply saved theme ---
            document.body.classList.add(appState.theme);

            // --- Setup Dropdowns ---
            setupDropdownToggle('notifications-button', 'notifications-content');
            setupDropdownToggle('user-profile-button', 'user-profile-content');

            // Close modals with the close button
            document.querySelectorAll('.modal-close').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.target.closest('.modal-overlay').classList.remove('show');
                });
            });

            // --- Theme Toggle Listener ---
            document.getElementById('theme-toggle').addEventListener('click', () => {
                const isDarkMode = document.body.classList.toggle('dark-mode');
                document.body.classList.toggle('light-mode', !isDarkMode);
                appState.theme = isDarkMode ? 'dark-mode' : 'light-mode';
                localStorage.setItem('theme', appState.theme);
                // Re-render charts to pick up new theme colors
                if (activityChartInstance) activityChartInstance.destroy();
                if (topEnginesChartInstance) topEnginesChartInstance.destroy();
                if (topCategoriesChartInstance) topCategoriesChartInstance.destroy();
                if (successfulExecutionsChartInstance) successfulExecutionsChartInstance.destroy();
                // Ensure correct chart context is used based on active module
                if (appState.activeModule === 'dashboard') {
                    activityChartCtx = document.getElementById('activity-chart').getContext('2d');
                    renderDashboard();
                } else if (appState.activeModule === 'analytics') {
                    // Re-get contexts as canvas might have been removed/re-added
                    topEnginesChartCtx = document.getElementById('top-engines-chart').getContext('2d');
                    topCategoriesChartCtx = document.getElementById('top-categories-chart').getContext('2d');
                    successfulExecutionsChartCtx = document.getElementById('successful-executions-chart').getContext('2d');
                    renderAnalyticsCharts();
                }
            });

            // --- Global Navigation Click Handler ---
            document.querySelectorAll('#left-sidebar .nav-item a, .app-logo-title, [data-nav-target]').forEach(element => {
                element.addEventListener('click', (event) => {
                    event.preventDefault();
                    // Find the closest ancestor with a 'data-module' or 'data-nav-target' attribute
                    const clickedElement = event.target.closest('[data-module], [data-nav-target]');
                    if (!clickedElement) return; // If no relevant parent found, exit.

                    const moduleName = clickedElement.dataset.module || clickedElement.dataset.navTarget;

                    if (moduleName && moduleName !== 'logout') {
                        switchModule(moduleName);
                    } else if (moduleName === 'logout') {
                        // In a real app, this would clear session, redirect to login
                        showToast('Logged out (demo action)!', 'info');
                        localStorage.clear(); // Clear local storage for demo
                        // Optionally: window.location.reload(); or redirect to login page
                    }
                });
            });

            // --- Initial Module Load ---
            const initialModule = window.location.hash ? window.location.hash.substring(1) : appState.activeModule;
            if (document.getElementById(initialModule)) {
                switchModule(initialModule);
            } else {
                switchModule('dashboard'); // Fallback to dashboard if hash is invalid
            }

            // --- Query Builder Event Listeners ---
            engineSelector.value = appState.defaultEngine;
            engineSelector.addEventListener('change', () => {
                appState.queryBuilderEngine = engineSelector.value; // Update stored engine
                appState.queryBuilderFields = [{ id: 'field-0', operator: 'keyword', value: '' }]; // Reset fields for new engine
                localStorage.setItem('queryBuilderEngine', appState.queryBuilderEngine);
                localStorage.setItem('queryBuilderFields', JSON.stringify(appState.queryBuilderFields));
                renderQueryBuilderFields(); // Re-render with new engine's default operators
            });

            addOperatorButton.addEventListener('click', addOperatorField);

            manualQueryInput.addEventListener('input', updateLivePreview); // Listener for manual input


            structuredModeBtn.addEventListener('click', () => {
                if (appState.queryBuilderMode !== 'structured') {
                    toggleQueryBuilderMode();
                }
            });

            manualModeBtn.addEventListener('click', () => {
                if (appState.queryBuilderMode !== 'manual') {
                    toggleQueryBuilderMode();
                }
            });

            // Initialize builder based on saved mode
            if (appState.queryBuilderMode === 'structured') {
                structuredQueryFieldsContainer.style.display = 'flex';
                addOperatorButton.style.display = 'inline-flex';
                manualQueryInput.style.display = 'none';
                structuredModeBtn.classList.add('active');
                manualModeBtn.classList.remove('active');
                renderQueryBuilderFields(); // Render existing or default fields
            } else {
                structuredQueryFieldsContainer.style.display = 'none';
                addOperatorButton.style.display = 'none';
                manualQueryInput.style.display = 'block';
                structuredModeBtn.classList.remove('active');
                manualModeBtn.classList.add('active');
                // If switching back to manual, ensure input is populated
                manualQueryInput.value = liveQueryPreview.textContent === 'Your constructed search query will appear here.' ? '' : liveQueryPreview.textContent;
                updateLivePreview();
            }


            copyLiveQueryButton.addEventListener('click', () => {
                const queryText = liveQueryPreview.textContent;
                if (queryText && queryText !== 'Your constructed search query will appear here.') {
                    navigator.clipboard.writeText(queryText).then(() => {
                        showToast('Query copied to clipboard!', 'success');
                    }).catch(err => {
                        console.error('Could not copy text: ', err);
                        showToast('Failed to copy query.', 'error');
                    });
                } else {
                    showToast('No query to copy.', 'info');
                }
            });


            document.getElementById('execute-query').addEventListener('click', () => {
                const query = liveQueryPreview.textContent.trim();
                const engine = engineSelector.value;
                const lintStatus = runQueryLinter(query, engine, appState.queryBuilderFields);
                if (lintStatus !== 'error') {
                    showToast('Query executed successfully (check console for URL or manually open)!', 'success');
                    // In a real app, this would hit an API and show results
                    console.log(`Executing query for ${engine}: ${query}`);
                    logUsage(engine, query, true);
                } else {
                    showToast('Please fix query errors before executing.', 'error');
                }
            });

            document.getElementById('execute-run-query').addEventListener('click', () => {
                const query = liveQueryPreview.textContent.trim();
                const engine = engineSelector.value;
                const lintStatus = runQueryLinter(query, engine, appState.queryBuilderFields);
                if (lintStatus !== 'error') {
                    const fullUrl = generateQueryUrl(query, engine);
                    window.open(fullUrl, '_blank');
                    showToast('Query executed and opened in new tab!', 'success');
                    logUsage(engine, query, true);
                } else {
                    showToast('Please fix query errors before executing.', 'error');
                }
            });

            document.getElementById('save-query').addEventListener('click', async () => {
                const query = liveQueryPreview.textContent.trim();
                const engine = engineSelector.value;
                if (!query || query === 'Your constructed search query will appear here.') {
                    showToast('Cannot save an empty query.', 'error');
                    return;
                }

                const queryName = await showSaveQueryModal('Save Query', `My ${engine.charAt(0).toUpperCase() + engine.slice(1)} Query`);
                if (queryName !== null && queryName.trim() !== '') {
                    const newQuery = { id: Date.now().toString(), name: queryName.trim(), query: query, engine: engine, favorited: false }; // Ensure unique ID
                    appState.savedQueries.push(newQuery);
                    localStorage.setItem('savedQueries', JSON.stringify(appState.savedQueries));
                    showToast('Query saved successfully!', 'success');
                    renderSavedQueries();
                } else if (queryName !== null) { // User clicked save but left name empty
                    showToast('Query name cannot be empty. Query not saved.', 'error');
                } else { // User clicked cancel
                    showToast('Query save cancelled.', 'info');
                }
            });

            document.getElementById('convert-query').addEventListener('click', () => {
                const query = liveQueryPreview.textContent.trim();
                if (query && query !== 'Your constructed search query will appear here.') {
                    switchModule('query-converter');
                    sourceQueryEditor.value = query;
                    converterSourceEngine.value = engineSelector.value;
                    targetQueryOutput.value = ''; // Clear previous output
                    conversionFeedback.style.display = 'none';
                } else {
                    showToast('Construct a query in the builder to convert.', 'error');
                }
            });


            // --- Template Library Event Listeners ---
            templateSearchInput.addEventListener('input', renderTemplateLibrary);
            filterCategory.addEventListener('change', renderTemplateLibrary);
            filterEngine.addEventListener('change', renderTemplateLibrary);
            filterRisk.addEventListener('change', renderTemplateLibrary);

            filterFavoritesButton.addEventListener('click', () => {
                appState.filterFavorites = !appState.filterFavorites;
                localStorage.setItem('filterFavorites', appState.filterFavorites);
                renderTemplateLibrary();
            });

            templateCardViewBtn.addEventListener('click', () => {
                appState.templateView = 'card-view';
                localStorage.setItem('templateView', 'card-view');
                renderTemplateLibrary();
            });

            templateListViewBtn.addEventListener('click', () => {
                appState.templateView = 'list-view';
                localStorage.setItem('templateView', 'list-view');
                renderTemplateLibrary();
            });

            // Template Detail Modal Action Buttons
            // ATTACH THESE LISTENERS HERE AFTER ALL TEMPLATE MODAL ELEMENTS ARE CACHED GLOBALLY
            templateModalCopyBtn.addEventListener('click', (e) => {
                const queryText = e.currentTarget.dataset.query;
                navigator.clipboard.writeText(queryText).then(() => {
                    showToast('Query copied to clipboard!', 'success');
                    templateDetailModal.classList.remove('show');
                }).catch(err => {
                    console.error('Could not copy text: ', err);
                    showToast('Failed to copy query.', 'error');
                });
            });

            templateModalCustomizeBtn.addEventListener('click', (e) => {
                const query = e.currentTarget.dataset.query;
                const engine = e.currentTarget.dataset.engine;

                // Load parsed fields into builder
                loadTemplateIntoQueryBuilder({ queryString: query, engineSupport: [engine] });

                switchModule('query-builder');
                templateDetailModal.classList.remove('show');
                showToast('Template loaded into Query Builder for customization!', 'success');
            });

            templateModalUseNowBtn.addEventListener('click', (e) => {
                const query = e.currentTarget.dataset.query;
                const engine = e.currentTarget.dataset.engine;
                const fullUrl = generateQueryUrl(query, engine);
                window.open(fullUrl, '_blank');
                logUsage(engine, query, true);
                templateDetailModal.classList.remove('show');
                showToast('Template executed and opened!', 'success');
            });

            // --- Saved Queries Event Listeners (Export/Import) ---
            document.getElementById('export-queries').addEventListener('click', () => {
                if (appState.savedQueries.length === 0) {
                    showToast('No queries to export!', 'info');
                    return;
                }
                const dataStr = JSON.stringify(appState.savedQueries, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `searchsploit_x_saved_queries_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Saved queries exported!', 'success');
            });

            document.getElementById('import-queries-button').addEventListener('click', () => {
                document.getElementById('import-queries-input').click();
            });

            document.getElementById('import-queries-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    if (file.type !== "application/json") {
                        showToast("Invalid file type. Please select a JSON file.", "error");
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedQueries = JSON.parse(e.target.result);
                            if (Array.isArray(importedQueries)) {
                                let importedCount = 0;
                                importedQueries.forEach(iq => {
                                    // Basic validation for imported query structure
                                    if (iq.name && iq.query && iq.engine) {
                                        // Generate new unique ID for imported queries to avoid clashes
                                        iq.id = iq.id || `imported-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
                                        iq.favorited = iq.favorited || false; // Ensure favorited property exists
                                        const existingIndex = appState.savedQueries.findIndex(sq => sq.id === iq.id);
                                        if (existingIndex > -1) {
                                            // Update existing if ID matches, or just skip? For demo, update.
                                            appState.savedQueries[existingIndex] = { ...appState.savedQueries[existingIndex], ...iq };
                                        } else {
                                            appState.savedQueries.push(iq);
                                            importedCount++;
                                        }
                                    }
                                });
                                localStorage.setItem('savedQueries', JSON.stringify(appState.savedQueries));
                                renderSavedQueries();
                                renderTemplateLibrary(); // Update template stars
                                showToast(`Successfully imported ${importedCount} new queries.`, 'success');
                            } else {
                                showToast('Invalid JSON file format. Expected an array of query objects.', 'error');
                            }
                        } catch (error) {
                            showToast('Failed to parse JSON file. Ensure it\'s valid JSON. ' + error.message, 'error');
                            console.error('Import error:', error);
                        } finally {
                             event.target.value = ''; // Clear file input
                        }
                    };
                    reader.readAsText(file);
                }
            });

            // --- Query Converter Event Listeners ---
            convertButton.addEventListener('click', () => {
                const sourceQuery = sourceQueryEditor.value.trim();
                const sourceEngine = converterSourceEngine.value;
                const targetEngine = converterTargetEngine.value;

                if (!sourceQuery) {
                    conversionFeedback.innerHTML = "<strong>Error:</strong> Please enter a query to convert.";
                    conversionFeedback.className = 'conversion-feedback active error';
                    conversionFeedback.style.display = 'block'; // Ensure it's visible
                    return;
                }

                if (sourceEngine === targetEngine) {
                    targetQueryOutput.value = sourceQuery;
                    conversionFeedback.style.display = 'none';
                    showToast('Source and target engines are the same. No conversion needed.', 'info');
                    return;
                }

                let result;
                const conversionFunctionName = `${sourceEngine}To${targetEngine.charAt(0).toUpperCase() + targetEngine.slice(1)}`;
                if (typeof conversionRules[conversionFunctionName] === 'function') {
                    result = conversionRules[conversionFunctionName](sourceQuery);
                } else {
                    result = conversionRules.defaultConversion(sourceQuery);
                }

                targetQueryOutput.value = result.query;
                if (result.warnings && result.warnings.length > 0) {
                    conversionFeedback.innerHTML = `<strong>Conversion Warnings:</strong><br>${result.warnings.join('<br>')}`;
                    conversionFeedback.className = 'conversion-feedback active warning';
                    conversionFeedback.style.display = 'block'; // Ensure it's visible
                    showToast('Query converted with warnings.', 'info');
                } else {
                    conversionFeedback.style.display = 'none';
                    conversionFeedback.className = 'conversion-feedback';
                    showToast('Query converted successfully!', 'success');
                }
            });

            // --- Random Dork Generator Event Listeners ---
            generateDorkButton.addEventListener('click', generateRandomDork);
            generatorEngine.addEventListener('change', generateRandomDork);
            generatorCategory.addEventListener('change', generateRandomDork);

            copyGeneratedDorkButton.addEventListener('click', () => {
                const queryText = generatedDorkQuery.textContent;
                if (queryText && queryText !== '_your_generated_dork_will_appear_here_') {
                    navigator.clipboard.writeText(queryText).then(() => {
                        showToast('Generated dork copied to clipboard!', 'success');
                    }).catch(err => {
                        console.error('Could not copy text: ', err);
                        showToast('Failed to copy dork.', 'error');
                    });
                } else {
                    showToast('No dork to copy.', 'info');
                }
            });

            autoRunDorkButton.addEventListener('click', () => {
                if (currentGeneratedDork) {
                    const engine = currentGeneratedDork.engineSupport[0] || 'google';
                    const fullUrl = generateQueryUrl(currentGeneratedDork.queryString, engine);
                    window.open(fullUrl, '_blank');
                    showToast('Random dork auto-executed!', 'success');
                    logUsage(engine, currentGeneratedDork.queryString, true);
                }
            });

            reviewDorkButton.addEventListener('click', () => {
                if (currentGeneratedDork) {
                    // Load parsed fields into builder
                    loadTemplateIntoQueryBuilder(currentGeneratedDork);
                    switchModule('query-builder');
                    showToast('Random dork loaded into Query Builder!', 'success');
                }
            });

            addToSavedDorkButton.addEventListener('click', async () => {
                if (currentGeneratedDork) {
                    const queryName = await showSaveQueryModal('Save Generated Dork', `[R] ${currentGeneratedDork.title}`);
                    if (queryName !== null && queryName.trim() !== '') {
                        const newQuery = {
                            id: `random-${Date.now()}`, // Unique ID for generated dork
                            name: queryName.trim(),
                            query: currentGeneratedDork.queryString,
                            engine: currentGeneratedDork.engineSupport[0] || 'google',
                            favorited: false
                        };
                        appState.savedQueries.push(newQuery);
                        localStorage.setItem('savedQueries', JSON.stringify(appState.savedQueries));
                        showToast('Random dork added to Saved Queries!', 'success');
                        renderSavedQueries();
                    } else if (queryName !== null) {
                         showToast('Query name cannot be empty. Dork not saved.', 'error');
                    } else {
                        showToast('Dork save cancelled.', 'info');
                    }
                }
            });

            // --- Wayback Machine Event Listeners ---
            lookupWaybackButton.addEventListener('click', () => {
                const url = waybackUrlInput.value.trim();
                waybackFeedback.style.display = 'none'; // Clear previous feedback

                if (!url) {
                    waybackFeedback.innerHTML = '<strong>Error:</strong> Please enter a URL.';
                    waybackFeedback.className = 'linter-feedback error active';
                    waybackFeedback.style.display = 'block';
                    waybackResultContainer.style.display = 'none';
                    return;
                }

                // Basic URL validation
                try {
                    new URL(url); // Check if it's a valid URL format
                } catch (e) {
                    waybackFeedback.innerHTML = '<strong>Error:</strong> Please enter a valid URL (e.g., https://example.com).';
                    waybackFeedback.className = 'linter-feedback error active';
                    waybackFeedback.style.display = 'block';
                    waybackResultContainer.style.display = 'none';
                    return;
                }

                // Construct Wayback Machine URL (common pattern)
                const waybackUrl = `https://web.archive.org/web/*/${url}`;
                waybackResultLink.href = waybackUrl;
                waybackDisplayUrl.textContent = url;
                waybackResultContainer.style.display = 'block';
                showToast('Wayback Machine link generated!', 'success');
            });

            copyWaybackLinkButton.addEventListener('click', () => {
                const link = waybackResultLink.href;
                if (link && link !== '#') {
                    navigator.clipboard.writeText(link).then(() => {
                        showToast('Wayback Machine link copied!', 'success');
                    }).catch(err => {
                        console.error('Could not copy text: ', err);
                        showToast('Failed to copy link.', 'error');
                    });
                } else {
                    showToast('No Wayback link to copy.', 'info');
                }
            });


            // --- Analytics & Usage History Event Listeners ---
            analyticsDateRangeSelect.addEventListener('change', renderAnalyticsCharts);

            document.getElementById('download-usage-csv').addEventListener('click', () => {
                let csv = 'Timestamp,Date,Engine,Query,Success,Category\n';
                appState.usageHistory.forEach(item => {
                    const cleanedQuery = `"${item.query.replace(/"/g, '""')}"`;
                    csv += `${new Date(item.timestamp).toISOString()},${item.date},${item.engine},${cleanedQuery},${item.success},${item.category || 'N/A'}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `searchsploit_x_usage_report_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Usage report downloaded (CSV)!', 'success');
            });

            document.getElementById('download-usage-pdf').addEventListener('click', () => {
                showToast('PDF export functionality is not available in this demo. Please use CSV export.', 'info', 5000);
            });

            // --- Settings Event Listeners ---
            document.getElementById('save-shodan-key').addEventListener('click', () => {
                appState.apiKeys.shodan = shodanApiKeyInput.value.trim();
                localStorage.setItem('apiKeys', JSON.stringify(appState.apiKeys));
                showToast('Shodan API Key saved.', 'success');
            });

            document.getElementById('save-censys-key').addEventListener('click', () => {
                appState.apiKeys.censys = censysApiKeyInput.value.trim();
                localStorage.setItem('apiKeys', JSON.stringify(appState.apiKeys));
                showToast('Censys API Key saved.', 'success');
            });

            defaultEngineSelect.addEventListener('change', () => {
                appState.defaultEngine = defaultEngineSelect.value;
                localStorage.setItem('defaultEngine', appState.defaultEngine);
                showToast('Default engine updated.', 'success');
            });

            // --- PWA Service Worker Registration Placeholder ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                   // console.log('Service Worker registration is commented out. For PWA, uncomment and provide a sw.js file.');
                });
            }
        });
    </script>
</body>
</html>
